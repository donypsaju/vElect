<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vElect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Libraries for generating PDF reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Library for generating audio tones -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; animation: fadeIn 0.5s ease-in-out; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 90%; max-width: 680px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-body { overflow-y: auto; }
        .counting-vote {
            animation: flyToCandidate 1s ease-in-out;
            position: absolute;
            font-size: 2rem;
            z-index: 100;
        }
        @keyframes flyToCandidate {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .disabled-card {
            opacity: 0.5;
            pointer-events: none;
        }
        /* Dynamic candidate card container */
        #candidate-cards {
            display: grid;
            gap: 1rem;
            place-items: center;
            height: calc(100vh - 220px); /* Adjust based on header height */
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div id="app-container" class="container mx-auto p-4">
        <!-- Header -->
        <header class="bg-white shadow rounded-lg p-4 mb-6 flex justify-between items-center">
            <h1 id="header-title" class="text-2xl font-bold text-blue-600">vElect - School Election Portal</h1>
            <div id="header-buttons" class="flex items-center space-x-4">
                <button id="instructions-btn" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">How to Use</button>
                <button id="logout-button" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Logout</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- STEP 1: Admin Login -->
            <div id="login-view" class="view active-view max-w-md mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
                <input id="admin-user" type="text" placeholder="Username" class="w-full p-3 mb-4 border rounded-lg" value="admin">
                <input id="admin-pass" type="password" placeholder="Password" class="w-full p-3 mb-4 border rounded-lg" value="admin123">
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Login</button>
            </div>

            <!-- STEP 2: School Setup -->
            <div id="school-setup-view" class="view max-w-lg mx-auto bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold mb-4">Setup School</h2>
                <p class="mb-4 text-gray-600">Enter the school code to begin.</p>
                <input id="school-code-input" type="text" placeholder="School Code" class="w-full p-3 mb-4 border rounded-lg">
                <div id="school-name-display" class="hidden p-3 mb-4 bg-green-100 text-green-800 rounded-lg"></div>
                <button id="confirm-school-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition">Confirm School</button>
                <button id="report-missing-school-btn" class="mt-4 w-full text-sm text-blue-600 hover:underline">Can't find your school?</button>
            </div>

            <!-- Admin Dashboard (Hub for all actions) -->
            <div id="admin-dashboard-view" class="view">
                <h2 class="text-3xl font-bold mb-6" id="dashboard-school-name"></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Student Data -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4">1. Student Data</h3>
                        <p class="text-gray-600 mb-4">Upload the student list (.xlsx). Columns: name, class, gender.</p>
                        <input type="file" id="student-file-input" accept=".xlsx, .xls" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <button id="download-sample-btn" class="mt-3 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">Download Sample File</button>
                        <div id="student-data-status" class="mt-4 text-green-600 font-semibold"></div>
                    </div>
                    <!-- Create/Update Election -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 id="election-form-title" class="text-xl font-bold mb-4">2. Create Election</h3>
                        <input id="election-name" type="text" placeholder="Election Name" class="w-full p-2 mb-3 border rounded">
                        <div class="relative">
                            <input id="election-password" type="password" placeholder="Security Password" class="w-full p-2 mb-3 border rounded pr-10">
                            <span id="toggle-password" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400 hover:text-gray-600">
                                <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2 2 0 01-2.828 2.828l-1.515-1.514a4 4 0 00-1.423-.93L3.086 3.086A9.948 9.948 0 0110 3a9.958 9.958 0 014.512 1.074l-1.78 1.781a4 4 0 00-4.95 4.95z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.022 7 9.542 7 .847 0 1.669-.105 2.454-.303z" /></svg>
                            </span>
                        </div>
                        <div class="flex items-center mb-3">
                            <input id="include-nota" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            <label for="include-nota" class="ml-2 block text-sm text-gray-900">Include NOTA</label>
                        </div>
                        <div id="election-form-buttons" class="space-y-2">
                           <button id="create-election-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg">Create</button>
                        </div>
                    </div>
                     <!-- Manage Elections -->
                    <div class="bg-white p-6 rounded-xl shadow-md md:col-span-2 lg:col-span-3">
                        <h3 class="text-xl font-bold mb-4">Manage Elections</h3>
                        <div id="election-list" class="space-y-2"></div>
                    </div>
                </div>

                <div id="active-election-section" class="mt-8 space-y-6 hidden">
                    <h2 class="text-2xl font-bold border-b pb-2">Active Election: <span id="active-election-name" class="text-blue-600"></span></h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Add Candidates -->
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">3. Add Candidates</h3>
                            <select id="candidate-class-select" class="w-full p-2 mb-3 border rounded"></select>
                            <select id="candidate-name-select" class="w-full p-2 mb-3 border rounded"></select>
                            <input id="candidate-gender" type="text" placeholder="Gender (auto-filled)" class="w-full p-2 mb-3 border rounded bg-gray-100" readonly>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Candidate Image</label>
                            <input type="file" id="candidate-image-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            <button id="add-candidate-btn" class="w-full mt-3 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 rounded-lg">Add Candidate</button>
                        </div>
                        <!-- Manage Candidates -->
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold mb-4">Manage Candidates</h3>
                            <div id="candidate-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                        </div>
                    </div>
                    <!-- Navigation to other sections -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold mb-4">4. Election Process</h3>
                        <div class="flex space-x-4">
                            <button id="goto-voting-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Start Voting</button>
                            <button id="goto-counting-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg">Start Counting</button>
                            <button id="goto-reports-btn" class="flex-1 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-lg">View Reports</button>
                        </div>
                    </div>
                </div>
                
                <!-- Data Management -->
                <div class="mt-8 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4">Data Management</h3>
                    <div class="flex space-x-4">
                        <button id="export-data-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Export Data</button>
                        <label for="import-data-input" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-center cursor-pointer">Import Data</label>
                        <input type="file" id="import-data-input" class="hidden" accept=".json">
                    </div>
                </div>

            </div>
            
            <!-- STEP 6 & 7: Voting View -->
            <div id="voting-class-selection-view" class="view"></div>
            <div id="voting-screen-view" class="view" oncontextmenu="return false;"></div>

            <!-- STEP 10 & 11: Counting View -->
            <div id="counting-class-selection-view" class="view"></div>
            <div id="counting-screen-view" class="view"></div>

            <!-- STEP 12: Reports View -->
            <div id="reports-view" class="view"></div>
        </main>
    </div>

    <!-- Modal for confirmations, password prompts, and results -->
    <div id="modal" class="modal-backdrop hidden">
        <div id="modal-content" class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="mt-6 flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="modal-confirm-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modal for Progress Bar -->
    <div id="progress-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="progress-title" class="text-xl font-bold mb-4">Processing Student Data...</h3>
            <div id="progress-body">
                <p id="progress-text" class="text-center mb-2">Starting...</p>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progress-bar" class="bg-blue-600 h-4 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <p id="progress-eta" class="text-center text-sm text-gray-500 mt-2">Calculating time remaining...</p>
            </div>
        </div>
    </div>


<script>
// --- APP INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let appData = {
        school: null,
        students: [],
        classes: {},
        elections: [],
        activeElectionId: null,
        currentVotingClass: null,
        currentVoterIndex: 0,
        loggedIn: false,
    };

    // This will hold the data from schools.json
    let schoolsData = [];

    // --- DOM ELEMENTS ---
    const views = document.querySelectorAll('.view');
    const headerTitle = document.getElementById('header-title');
    const headerButtons = document.getElementById('header-buttons');
    const logoutButton = document.getElementById('logout-button');
    const instructionsButton = document.getElementById('instructions-btn');
    const mainContent = document.getElementById('main-content');
    
    // --- DEFAULT IMAGES ---
    const femaleIcon = 'female.png';
    const maleIcon = 'male.png';

    // --- IndexedDB HELPER ---
    const db = {
        instance: null,
        init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ElectionDB', 1);
                request.onupgradeneeded = (event) => {
                    const dbInstance = event.target.result;
                    dbInstance.createObjectStore('candidate_images', { keyPath: 'id' });
                };
                request.onsuccess = (event) => {
                    this.instance = event.target.result;
                    resolve();
                };
                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        },
        addImage(id, imageFile) {
            return new Promise((resolve, reject) => {
                const transaction = this.instance.transaction(['candidate_images'], 'readwrite');
                const store = transaction.objectStore('candidate_images');
                const request = store.put({ id: id, image: imageFile });
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        },
        getImage(id) {
            return new Promise((resolve, reject) => {
                const transaction = this.instance.transaction(['candidate_images'], 'readonly');
                const store = transaction.objectStore('candidate_images');
                const request = store.get(id);
                request.onsuccess = (event) => resolve(event.target.result?.image);
                request.onerror = (event) => reject(event.target.error);
            });
        },
        deleteImage(id) {
            return new Promise((resolve, reject) => {
                const transaction = this.instance.transaction(['candidate_images'], 'readwrite');
                const store = transaction.objectStore('candidate_images');
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
    };

    // --- UTILITY FUNCTIONS ---
    const saveState = () => {
        try {
            // Don't save images in localStorage
            const stateToSave = { ...appData };
            stateToSave.elections = appData.elections.map(election => {
                const electionCopy = { ...election };
                electionCopy.candidates = election.candidates.map(c => {
                    const { image, ...rest } = c; // Exclude image property
                    return rest;
                });
                return electionCopy;
            });
            localStorage.setItem('electionAppData', JSON.stringify(stateToSave));
        } catch (e) {
            console.error("Error saving state:", e);
            showModal({ title: 'Error', body: 'Could not save state. The browser storage might be full.', cancelText: 'OK' });
        }
    };

    const loadState = () => {
        const savedData = localStorage.getItem('electionAppData');
        if (savedData) {
            appData = JSON.parse(savedData);
            if (!Array.isArray(appData.elections)) {
                appData.elections = [];
            }
            if (appData.loggedIn) {
                if(appData.school) {
                    showView('admin-dashboard-view');
                    renderAdminDashboard();
                } else {
                    showView('school-setup-view');
                }
            }
        }
    };

    const showView = (viewId) => {
        views.forEach(v => v.classList.remove('active-view'));
        const targetView = document.getElementById(viewId);
        if (targetView) {
            targetView.classList.add('active-view');
            mainContent.appendChild(targetView);
        }
        const isLoggedIn = appData.loggedIn && viewId !== 'login-view';
        logoutButton.classList.toggle('hidden', !isLoggedIn);
        instructionsButton.classList.toggle('hidden', !isLoggedIn);
        
        headerButtons.classList.toggle('hidden', viewId === 'voting-screen-view' || viewId === 'counting-screen-view');
        headerTitle.textContent = appData.school ? `${appData.school.name} Election` : 'School Election Portal';
    };

    const showModal = (config) => {
        const { title, body, onConfirm, confirmText = 'Confirm', onCancel, cancelText = 'Cancel', requiresInput = false } = config;
        document.getElementById('modal-title').textContent = title;
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = body;
        if (requiresInput) {
            modalBody.innerHTML += `<input type="password" id="modal-password-input" class="w-full p-2 mt-4 border rounded">`;
        }

        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        
        confirmBtn.textContent = confirmText;
        cancelBtn.textContent = cancelText;

        if (onConfirm) {
            confirmBtn.classList.remove('hidden');
            confirmBtn.onclick = () => {
                const input = document.getElementById('modal-password-input');
                const inputValue = input ? input.value : null;
                onConfirm(inputValue);
                hideModal();
            };
        } else {
            confirmBtn.classList.add('hidden');
        }
        
        cancelBtn.onclick = () => {
            if (onCancel) onCancel();
            hideModal();
        };

        document.getElementById('modal').classList.remove('hidden');
    };

    const hideModal = () => document.getElementById('modal').classList.add('hidden');

    const getActiveElection = () => appData.elections.find(e => e.id.toString() === appData.activeElectionId);

    // --- FULLSCREEN API ---
    const enterFullScreen = (element) => {
        if (element.requestFullscreen) element.requestFullscreen();
        else if (element.mozRequestFullScreen) element.mozRequestFullScreen();
        else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
        else if (element.msRequestFullscreen) element.msRequestFullscreen();
    };

    const exitFullScreen = () => {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
    };
    
    // --- STEP 1: LOGIN ---
    document.getElementById('login-btn').addEventListener('click', () => {
        const user = document.getElementById('admin-user').value;
        const pass = document.getElementById('admin-pass').value;
        if (user === 'admin' && pass === 'admin123') {
            appData.loggedIn = true;
            if (appData.school) {
                showView('admin-dashboard-view');
                renderAdminDashboard();
            } else {
                showView('school-setup-view');
            }
            saveState();
        } else {
            showModal({ title: 'Login Failed', body: 'Invalid username or password.', cancelText: 'OK' });
        }
    });
    
    logoutButton.addEventListener('click', () => {
        appData.loggedIn = false;
        showView('login-view');
        localStorage.removeItem('electionAppData');
        window.location.reload();
    });

    // --- STEP 2: SCHOOL SETUP ---
    document.getElementById('confirm-school-btn').addEventListener('click', () => {
        const code = document.getElementById('school-code-input').value.trim();
        const schoolInfo = schoolsData.find(school => 
            school.school_code === code || 
            school.hss_code === code || 
            school.vhse_code === code
        );
        
        if (schoolInfo) {
            appData.school = { code, name: schoolInfo.school_name };
            saveState();
            showView('admin-dashboard-view');
            renderAdminDashboard();
        } else {
            showModal({ title: 'Error', body: 'Invalid School Code. Please try again or report if your school is missing.', cancelText: 'OK' });
        }
    });

    document.getElementById('report-missing-school-btn').addEventListener('click', () => {
        const formHTML = `
            <p class="mb-4">If your school is not listed, please fill out this form to request it be added.</p>
            <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSevJGeya80M4LqgWQVs-9b56nNi1fThPgJNfP_9sVZ4_pT5Vw/viewform?embedded=true" 
                width="100%" height="450" frameborder="0" marginheight="0" marginwidth="0">Loading…</iframe>
        `;
        showModal({
            title: 'Report Missing School',
            body: formHTML,
            cancelText: 'Close'
        });
    });

    // --- STEP 3: STUDENT DATA (Using Web Worker) ---
    document.getElementById('student-file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) startStudentProcessingWithWorker(file);
    });

    const startStudentProcessingWithWorker = (file) => {
        document.getElementById('progress-modal').classList.remove('hidden');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressEta = document.getElementById('progress-eta');
        
        progressBar.style.width = '0%';
        progressText.textContent = 'Preparing to read file...';
        progressEta.textContent = 'Calculating time remaining...';

        const workerCode = `
            self.onmessage = function(e) {
                const { file, xlsxURL } = e.data;
                importScripts(xlsxURL);
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const rawStudents = XLSX.utils.sheet_to_json(worksheet);

                        const students = rawStudents.map(row => {
                            const normalizedRow = {};
                            for (const key in row) {
                                if (Object.prototype.hasOwnProperty.call(row, key)) {
                                    normalizedRow[key.trim().toLowerCase()] = row[key];
                                }
                            }
                            return normalizedRow;
                        }).filter(row => row.class && row.name);

                        const totalCount = students.length;
                        let processedCount = 0;
                        const classes = {};
                        const studentList = [];

                        for (const s of students) {
                            const studentRecord = { ...s, class: s.class.toString().trim() };
                            studentList.push(studentRecord);
                            const className = studentRecord.class;
                            if (!classes[className]) classes[className] = [];
                            classes[className].push(studentRecord);
                            processedCount++;
                            if (processedCount % 10 === 0 || processedCount === totalCount) {
                                self.postMessage({ type: 'progress', processed: processedCount, total: totalCount });
                            }
                        }
                        self.postMessage({ type: 'done', students: studentList, classes: classes });
                    } catch (error) {
                        self.postMessage({ type: 'error', message: error.message });
                    }
                };
                reader.readAsArrayBuffer(file);
            };
        `;

        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob));
        const startTime = Date.now();

        worker.onmessage = (e) => {
            const { type, processed, total, students, classes, message } = e.data;
            if (type === 'progress') {
                const percentage = total > 0 ? (processed / total) * 100 : 0;
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `Processed ${processed} of ${total} students...`;
                if (processed > 0) {
                    const elapsedTime = Date.now() - startTime;
                    const timePerStudent = elapsedTime / processed;
                    const remainingStudents = total - processed;
                    const etaMs = remainingStudents * timePerStudent;
                    const etaSeconds = Math.round(etaMs / 1000);
                    progressEta.textContent = `Estimated time remaining: ${etaSeconds} seconds`;
                }
            } else if (type === 'done') {
                appData.students = students;
                appData.classes = classes;
                document.getElementById('progress-modal').classList.add('hidden');
                saveState();
                renderAdminDashboard();
                const classList = Object.keys(appData.classes).sort().join(', ');
                showModal({
                    title: "Student Data Processed Successfully",
                    body: `<p><strong>Total Students:</strong> ${appData.students.length}</p><p><strong>Total Classes:</strong> ${Object.keys(appData.classes).length}</p><p class="mt-2"><strong>Classes Found:</strong> ${classList}</p>`,
                    cancelText: 'OK'
                });
                worker.terminate();
            } else if (type === 'error') {
                showModal({ title: 'Error', body: 'An error occurred while processing the file: ' + message, cancelText: 'OK' });
                document.getElementById('progress-modal').classList.add('hidden');
                worker.terminate();
            }
        };
        worker.postMessage({ file: file, xlsxURL: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js' });
    };

    // --- STEP 4: ELECTION MANAGEMENT ---
    const renderElectionForm = (election = null) => {
        const isEditing = !!election;
        document.getElementById('election-form-title').textContent = isEditing ? 'Update Election' : '2. Create Election';
        document.getElementById('election-name').value = isEditing ? election.name : '';
        document.getElementById('election-password').value = isEditing ? election.password : '';
        document.getElementById('include-nota').checked = isEditing ? election.includeNota : false;

        const buttonsContainer = document.getElementById('election-form-buttons');
        if (isEditing) {
            buttonsContainer.innerHTML = `
                <button id="update-election-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg">Update</button>
                <button id="cancel-update-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">Cancel</button>
            `;
            document.getElementById('update-election-btn').onclick = () => updateElection(election.id);
            document.getElementById('cancel-update-btn').onclick = () => renderElectionForm();
        } else {
            buttonsContainer.innerHTML = `<button id="create-election-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg">Create</button>`;
            document.getElementById('create-election-btn').onclick = createElection;
        }
    };

    const createElection = () => {
        const name = document.getElementById('election-name').value;
        const password = document.getElementById('election-password').value;
        const includeNota = document.getElementById('include-nota').checked;
        if (name && password) {
            appData.elections.push({
                id: Date.now().toString(),
                name,
                password,
                includeNota,
                candidates: [],
                votes: {},
                classStatus: {}
            });
            saveState();
            renderAdminDashboard();
            renderElectionForm(); // Reset form
        } else {
            showModal({ title: 'Error', body: 'Please provide both an election name and a password.', cancelText: 'OK' });
        }
    };

    const updateElection = (electionId) => {
        const election = appData.elections.find(e => e.id === electionId);
        if (election) {
            election.name = document.getElementById('election-name').value;
            election.password = document.getElementById('election-password').value;
            election.includeNota = document.getElementById('include-nota').checked;
            saveState();
            renderAdminDashboard();
            renderElectionForm();
        }
    };

    const deleteElection = (electionId) => {
        const election = appData.elections.find(e => e.id === electionId);
        const isVotingStarted = Object.values(election.classStatus).some(s => s.status === 'voted' || s.status === 'counted');
        if (isVotingStarted) {
            showModal({ title: 'Error', body: 'Cannot delete an election after voting has started.', cancelText: 'OK' });
            return;
        }
        showModal({
            title: 'Delete Election?',
            body: `Are you sure you want to delete the election "${election.name}"? This action cannot be undone.`,
            confirmText: 'Delete',
            onConfirm: () => {
                appData.elections = appData.elections.filter(e => e.id !== electionId);
                if (appData.activeElectionId === electionId) {
                    appData.activeElectionId = null;
                }
                saveState();
                renderAdminDashboard();
            }
        });
    };

    const selectElection = (electionId) => {
        appData.activeElectionId = electionId;
        saveState();
        renderAdminDashboard();
    };

    document.getElementById('toggle-password').addEventListener('click', () => {
        const passwordInput = document.getElementById('election-password');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeOffIcon = document.getElementById('eye-off-icon');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.classList.add('hidden');
            eyeOffIcon.classList.remove('hidden');
        } else {
            passwordInput.type = 'password';
            eyeIcon.classList.remove('hidden');
            eyeOffIcon.classList.add('hidden');
        }
    });

    // --- STEP 5: CANDIDATE MANAGEMENT ---
    const populateClassSelect = () => {
        const select = document.getElementById('candidate-class-select');
        select.innerHTML = '<option>Select a class</option>';
        Object.keys(appData.classes).sort().forEach(className => {
            select.innerHTML += `<option value="${className}">${className}</option>`;
        });
    };

    document.getElementById('candidate-class-select').addEventListener('change', (e) => {
        const className = e.target.value;
        const nameSelect = document.getElementById('candidate-name-select');
        nameSelect.innerHTML = '<option>Select a student</option>';
        if (appData.classes[className]) {
            const sortedStudents = [...appData.classes[className]].sort((a, b) => {
                const aGender = a.gender?.toLowerCase() || 'z';
                const bGender = b.gender?.toLowerCase() || 'z';
                if (aGender.startsWith('f') && !bGender.startsWith('f')) return -1;
                if (!aGender.startsWith('f') && bGender.startsWith('f')) return 1;
                return a.name.localeCompare(b.name);
            });
            sortedStudents.forEach(student => {
                nameSelect.innerHTML += `<option value="${student.name}">${student.name}</option>`;
            });
        }
    });

    document.getElementById('candidate-name-select').addEventListener('change', (e) => {
        const studentName = e.target.value;
        const className = document.getElementById('candidate-class-select').value;
        const student = appData.classes[className]?.find(s => s.name === studentName);
        document.getElementById('candidate-gender').value = student ? student.gender : '';
    });

    document.getElementById('add-candidate-btn').addEventListener('click', async () => {
        const election = getActiveElection();
        const className = document.getElementById('candidate-class-select').value;
        const name = document.getElementById('candidate-name-select').value;
        const gender = document.getElementById('candidate-gender').value;
        const imageFile = document.getElementById('candidate-image-input').files[0];

        if (!election) { showModal({ title: 'Error', body: 'Select an active election first.', cancelText: 'OK' }); return; }
        if (className === 'Select a class' || name === 'Select a student') {
            showModal({ title: 'Error', body: 'Please fill all candidate details.', cancelText: 'OK' });
            return;
        }

        const newCandidate = {
            id: Date.now().toString(), // Use string for ID consistency
            name,
            class: className,
            gender,
            hasImage: !!imageFile
        };

        try {
            if (imageFile) {
                await db.addImage(newCandidate.id, imageFile);
            }
            election.candidates.push(newCandidate);
            saveState();
            showModal({ title: 'Success', body: `Candidate ${name} added successfully.`, cancelText: 'OK' });
            renderCandidateList();
            document.getElementById('candidate-class-select').value = 'Select a class';
            document.getElementById('candidate-name-select').innerHTML = '<option>Select a student</option>';
            document.getElementById('candidate-gender').value = '';
            document.getElementById('candidate-image-input').value = '';
        } catch (error) {
            console.error("Failed to add candidate image to DB:", error);
            showModal({ title: 'Error', body: 'Could not save candidate image. The database might be full or corrupted.', cancelText: 'OK' });
        }
    });

    const deleteCandidate = async (candidateId) => {
        const election = getActiveElection();
        const candidate = election.candidates.find(c => c.id === candidateId);
        const classStatus = election.classStatus[candidate.class]?.status;

        if (classStatus === 'voted' || classStatus === 'counted') {
            showModal({ title: 'Error', body: `Cannot delete candidate from Class ${candidate.class} as voting has already started or completed.`, cancelText: 'OK' });
            return;
        }

        showModal({
            title: 'Delete Candidate?',
            body: `Are you sure you want to delete candidate "${candidate.name}"?`,
            confirmText: 'Delete',
            onConfirm: async () => {
                try {
                    if (candidate.hasImage) {
                        await db.deleteImage(candidateId);
                    }
                    election.candidates = election.candidates.filter(c => c.id !== candidateId);
                    saveState();
                    renderCandidateList();
                } catch (error) {
                    console.error("Failed to delete candidate image:", error);
                    showModal({ title: 'Error', body: 'Could not delete candidate image from the database.', cancelText: 'OK' });
                }
            }
        });
    };

    // --- RENDER FUNCTIONS ---
    const renderAdminDashboard = () => {
        document.getElementById('dashboard-school-name').textContent = `Dashboard: ${appData.school.name}`;
        if (appData.students.length > 0) {
            document.getElementById('student-data-status').textContent = `${appData.students.length} students loaded.`;
            populateClassSelect();
        }
        renderElectionList();
        const activeElection = getActiveElection();
        const activeSection = document.getElementById('active-election-section');
        if (activeElection) {
            activeSection.classList.remove('hidden');
            document.getElementById('active-election-name').textContent = activeElection.name;
            renderCandidateList();
        } else {
            activeSection.classList.add('hidden');
        }
    };

    const renderElectionList = () => {
        const listContainer = document.getElementById('election-list');
        if (appData.elections.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500">No elections created yet.</p>';
            return;
        }
        listContainer.innerHTML = appData.elections.map(election => `
            <div class="flex items-center justify-between p-3 rounded-lg ${appData.activeElectionId === election.id ? 'bg-blue-100 border border-blue-400' : 'bg-gray-100'}">
                <span class="font-semibold">${election.name}</span>
                <div class="space-x-2">
                    <button class="select-election-btn text-sm py-1 px-3 rounded ${appData.activeElectionId === election.id ? 'bg-gray-500 text-white cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white'}" data-id="${election.id}" ${appData.activeElectionId === election.id ? 'disabled' : ''}>${appData.activeElectionId === election.id ? 'Selected' : 'Select'}</button>
                    <button class="edit-election-btn text-sm py-1 px-3 rounded bg-yellow-500 hover:bg-yellow-600 text-white" data-id="${election.id}">Edit</button>
                    <button class="delete-election-btn text-sm py-1 px-3 rounded bg-red-500 hover:bg-red-600 text-white" data-id="${election.id}">Delete</button>
                </div>
            </div>
        `).join('');

        listContainer.querySelectorAll('.select-election-btn').forEach(b => b.onclick = (e) => selectElection(e.target.dataset.id));
        listContainer.querySelectorAll('.edit-election-btn').forEach(b => b.onclick = (e) => renderElectionForm(appData.elections.find(el => el.id.toString() === e.target.dataset.id)));
        listContainer.querySelectorAll('.delete-election-btn').forEach(b => b.onclick = (e) => deleteElection(e.target.dataset.id));
    };

    const renderCandidateList = () => {
        const election = getActiveElection();
        const listContainer = document.getElementById('candidate-list');
        if (!election || election.candidates.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500">No candidates added to this election yet.</p>';
            return;
        }

        const candidatesByClass = election.candidates.reduce((acc, c) => {
            if (!acc[c.class]) acc[c.class] = [];
            acc[c.class].push(c);
            return acc;
        }, {});

        listContainer.innerHTML = Object.keys(candidatesByClass).sort().map(className => `
            <div>
                <h4 class="font-bold text-gray-700">${className}</h4>
                <ul class="list-disc list-inside ml-4">
                    ${candidatesByClass[className].map(c => `
                        <li class="flex justify-between items-center">
                            <span>${c.name}</span>
                            <button class="delete-candidate-btn text-xs text-red-500 hover:text-red-700" data-id="${c.id}">Delete</button>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `).join('');

        listContainer.querySelectorAll('.delete-candidate-btn').forEach(b => b.onclick = (e) => deleteCandidate(e.target.dataset.id));
    };
    
    // --- NAVIGATION ---
    document.getElementById('goto-voting-btn').addEventListener('click', () => {
        if (!getActiveElection()) { showModal({ title: 'Error', body: 'Select an active election first.', cancelText: 'OK' }); return; }
        renderVotingClassSelection();
        showView('voting-class-selection-view');
    });
    document.getElementById('goto-counting-btn').addEventListener('click', () => {
        if (!getActiveElection()) { showModal({ title: 'Error', body: 'Select an active election first.', cancelText: 'OK' }); return; }
        renderCountingClassSelection();
        showView('counting-class-selection-view');
    });
    document.getElementById('goto-reports-btn').addEventListener('click', () => {
        if (!getActiveElection()) { showModal({ title: 'Error', body: 'Select an active election first.', cancelText: 'OK' }); return; }
        renderReportsView();
        showView('reports-view');
    });

    // --- STEP 6 & 7: VOTING PROCESS ---
    const renderVotingClassSelection = () => {
        const election = getActiveElection();
        const container = document.getElementById('voting-class-selection-view');
        container.innerHTML = `<h2 class="text-3xl font-bold mb-6">Start Voting for a Class</h2>
            <button id="back-to-dash-1" class="mb-4 bg-gray-500 text-white p-2 rounded">Back to Dashboard</button>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                ${Object.keys(appData.classes).sort().map(className => {
                    const status = election.classStatus[className]?.status;
                    const isCompleted = status === 'voted' || status === 'counted';
                    return `
                        <button 
                            class="p-4 rounded-lg shadow-md text-white font-bold text-xl ${isCompleted ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}"
                            data-class="${className}"
                            ${isCompleted ? 'disabled' : ''}
                        >
                            ${className}
                            ${isCompleted ? '<br><span class="text-sm font-normal">Completed</span>' : ''}
                        </button>
                    `;
                }).join('')}
            </div>`;

        container.querySelector('#back-to-dash-1').addEventListener('click', () => showView('admin-dashboard-view'));
        container.querySelectorAll('button[data-class]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const className = e.currentTarget.dataset.class;
                showModal({
                    title: `Start Election for Class ${className}`,
                    body: `Please enter the election security password.`,
                    requiresInput: true,
                    onConfirm: (password) => {
                        if (password === election.password) {
                            startVotingForClass(className);
                        } else {
                            showModal({ title: 'Error', body: 'Incorrect password.', cancelText: 'OK' });
                        }
                    }
                });
            });
        });
    };

    const startVotingForClass = (className) => {
        appData.currentVotingClass = className;
        appData.currentVoterIndex = 0;
        const election = getActiveElection();
        if (!election.votes[className]) {
            election.votes[className] = [];
        }
        renderVotingScreen();
        showView('voting-screen-view');
        enterFullScreen(document.documentElement); // Enter fullscreen
    };

    const renderVotingScreen = async () => {
        const election = getActiveElection();
        const container = document.getElementById('voting-screen-view');
        const className = appData.currentVotingClass;
        const totalVoters = appData.classes[className].length;
        let candidates = election.candidates.filter(c => c.class === className);
        
        const totalCandidates = candidates.length + (election.includeNota ? 1 : 0);
        let gridClass = 'grid-cols-2';
        if (totalCandidates > 9) gridClass = 'grid-cols-5';
        else if (totalCandidates > 6) gridClass = 'grid-cols-4';
        else if (totalCandidates > 4) gridClass = 'grid-cols-3';

        let cardSizeClass = 'p-2';
        let imageSizeClass = 'w-24 h-24 md:w-32 md:h-32';
        let textSizeClass = 'text-lg';

        if (totalCandidates <= 4) {
            cardSizeClass = 'p-6';
            imageSizeClass = 'w-32 h-32 md:w-48 md:h-48';
            textSizeClass = 'text-2xl';
        } else if (totalCandidates <= 9) {
            cardSizeClass = 'p-4';
            imageSizeClass = 'w-24 h-24 md:w-32 md:h-32';
            textSizeClass = 'text-xl';
        }

        let notaCardHTML = '';
        if (election.includeNota) {
            notaCardHTML = `
                <div class="candidate-card bg-gray-200 rounded-2xl shadow-lg text-center cursor-pointer transition-transform transform hover:scale-105 flex flex-col items-center justify-center ${cardSizeClass}" data-candidate-id="NOTA">
                    <div class="${imageSizeClass} mx-auto rounded-full bg-gray-300 flex items-center justify-center border-4 border-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                        </svg>
                    </div>
                    <h3 class="mt-2 ${textSizeClass} font-bold">NOTA</h3>
                </div>
            `;
        }

        container.innerHTML = `
            <div class="text-center pt-4">
                <h2 class="text-4xl font-bold">Voting for Class ${className}</h2>
                <p id="voter-counter" class="text-2xl mt-2 text-gray-600">Voter ${appData.currentVoterIndex + 1} of ${totalVoters}</p>
                <p class="text-lg mt-4">Click on the candidate of your choice.</p>
            </div>
            <div id="candidate-cards" class="grid ${gridClass}">
                ${candidates.map(c => `
                    <div class="candidate-card bg-white rounded-2xl shadow-lg text-center cursor-pointer transition-transform transform hover:scale-105 flex flex-col items-center justify-center ${cardSizeClass}" data-candidate-id="${c.id}">
                        <img id="img-${c.id}" src="" alt="${c.name}" class="${imageSizeClass} mx-auto rounded-full object-cover border-4 border-gray-200 bg-gray-200">
                        <h3 class="mt-2 ${textSizeClass} font-bold">${c.name}</h3>
                    </div>
                `).join('')}
                ${notaCardHTML}
            </div>
            <div id="vote-cast-overlay" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col justify-center items-center text-white z-50">
                <h2 class="text-5xl font-bold">Vote Cast!</h2>
                <p class="text-2xl mt-4">Please wait for the admin to continue.</p>
            </div>
        `;

        // Asynchronously load images
        for (const c of candidates) {
            const imgElement = document.getElementById(`img-${c.id}`);
            if (c.hasImage) {
                db.getImage(c.id).then(imageBlob => {
                    if (imageBlob) {
                        imgElement.src = URL.createObjectURL(imageBlob);
                    }
                });
            } else {
                const gender = c.gender?.toLowerCase() || '';
                imgElement.src = gender.startsWith('f') ? femaleIcon : maleIcon;
            }
        }

        container.querySelectorAll('.candidate-card').forEach(card => {
            card.addEventListener('click', handleVoteCast);
        });
    };
    
    const handleVoteCast = (e) => {
        const card = e.currentTarget;
        const candidateId = card.dataset.candidateId;
        const election = getActiveElection();

        const synth = new Tone.Synth().toDestination();
        synth.triggerAttackRelease("C5", "4n");

        election.votes[appData.currentVotingClass].push({
            voterIndex: appData.currentVoterIndex,
            candidateId: candidateId
        });
        saveState();

        document.getElementById('vote-cast-overlay').classList.remove('hidden');
        document.querySelectorAll('.candidate-card').forEach(c => c.style.pointerEvents = 'none');
    };

    const endVotingSession = () => {
        const election = getActiveElection();
        exitFullScreen();
        showModal({
            title: `End Election for Class ${appData.currentVotingClass}`,
            body: `Please enter the election security password to confirm.`,
            requiresInput: true,
            onConfirm: (password) => {
                if (password === election.password) {
                    election.classStatus[appData.currentVotingClass] = { status: 'voted' };
                    saveState();
                    renderVotingClassSelection();
                    showView('voting-class-selection-view');
                } else {
                    showModal({ title: 'Error', body: 'Incorrect password.', cancelText: 'OK' });
                }
            }
        });
    };

    // Keyboard listener for admin
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('voting-screen-view').classList.contains('active-view')) {
            const election = getActiveElection();
            if (e.key === 'Tab') {
                e.preventDefault();
                if (election.votes[appData.currentVotingClass].length > appData.currentVoterIndex) {
                    appData.currentVoterIndex++;
                    const totalVoters = appData.classes[appData.currentVotingClass].length;
                    if (appData.currentVoterIndex < totalVoters) {
                        renderVotingScreen();
                    } else {
                        document.getElementById('voter-counter').innerHTML = '<span class="text-green-600 font-bold">All students have voted! Press ESC to finish.</span>';
                    }
                } else {
                    showModal({ title: 'Wait', body: "The current voter hasn't voted yet.", cancelText: 'OK' });
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                endVotingSession();
            }
        }
    });

    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && document.getElementById('voting-screen-view').classList.contains('active-view')) {
            endVotingSession();
        }
    });


    // --- STEP 10 & 11: COUNTING PROCESS ---
    const renderCountingClassSelection = () => {
        const election = getActiveElection();
        const container = document.getElementById('counting-class-selection-view');
        const allVoted = Object.keys(appData.classes).every(c => election.classStatus[c]?.status === 'voted' || election.classStatus[c]?.status === 'counted');
        
        container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Start Counting for a Class</h2>
            <button id="back-to-dash-2" class="mb-4 bg-gray-500 text-white p-2 rounded">Back to Dashboard</button>
            ${!allVoted ? `<div class="p-4 mb-4 bg-yellow-100 text-yellow-800 rounded-lg">Note: Not all classes have completed voting.</div>` : ''}
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                ${Object.keys(appData.classes).sort().map(className => {
                    const status = election.classStatus[className]?.status;
                    const canCount = status === 'voted';
                    const isCounted = status === 'counted';
                    let btnClass = 'bg-gray-400 cursor-not-allowed';
                    if (canCount) btnClass = 'bg-purple-600 hover:bg-purple-700';
                    if (isCounted) btnClass = 'bg-gray-400 cursor-not-allowed';

                    return `
                        <button 
                            class="p-4 rounded-lg shadow-md text-white font-bold text-xl ${btnClass}"
                            data-class="${className}"
                            ${!canCount ? 'disabled' : ''}
                        >
                            ${className}
                            ${isCounted ? '<br><span class="text-sm font-normal">Counted</span>' : ''}
                        </button>
                    `;
                }).join('')}
            </div>
        `;
        container.querySelector('#back-to-dash-2').addEventListener('click', () => showView('admin-dashboard-view'));
        container.querySelectorAll('button[data-class]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const className = e.currentTarget.dataset.class;
                showModal({
                    title: `Start Counting for Class ${className}`,
                    body: `Please enter the election security password.`,
                    requiresInput: true,
                    onConfirm: (password) => {
                        if (password === election.password) {
                            startCountingForClass(className);
                        } else {
                            showModal({ title: 'Error', body: 'Incorrect password.', cancelText: 'OK' });
                        }
                    }
                });
            });
        });
    };
    
    const startCountingForClass = (className) => {
        renderCountingScreen(className);
        showView('counting-screen-view');
    };

    const renderCountingScreen = (className) => {
        const election = getActiveElection();
        const container = document.getElementById('counting-screen-view');
        const candidates = election.candidates
            .filter(c => c.class === className)
            .map(c => ({ ...c, votes: 0 }));

        container.innerHTML = `
            <div class="text-center">
                <h2 class="text-4xl font-bold">Counting Votes for Class ${className}</h2>
                <p id="counting-status" class="text-2xl mt-2 text-gray-600">Ready to start counting.</p>
                <button id="begin-counting-btn" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-xl">Begin Counting</button>
            </div>
            <div id="counting-candidate-list" class="mt-8 space-y-4">
                ${candidates.map(c => `
                    <div class="candidate-result-item flex items-center bg-white p-4 rounded-lg shadow" data-candidate-id="${c.id}" data-votes="0">
                        <img id="img-count-${c.id}" src="" class="w-16 h-16 rounded-full mr-4 object-cover bg-gray-200">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold">${c.name}</h3>
                            <div class="w-full bg-gray-200 rounded-full h-4 mt-1">
                                <div class="bg-blue-600 h-4 rounded-full" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="text-2xl font-bold w-24 text-right" id="vote-count-${c.id}">0</div>
                    </div>
                `).join('')}
            </div>
        `;

        // Asynchronously load images
        for (const c of candidates) {
            const imgElement = document.getElementById(`img-count-${c.id}`);
             if (c.hasImage) {
                db.getImage(c.id).then(imageBlob => {
                    if (imageBlob) {
                        imgElement.src = URL.createObjectURL(imageBlob);
                    }
                });
            } else {
                const gender = c.gender?.toLowerCase() || '';
                imgElement.src = gender.startsWith('f') ? femaleIcon : maleIcon;
            }
        }

        document.getElementById('begin-counting-btn').addEventListener('click', (e) => {
            e.target.disabled = true;
            e.target.textContent = 'Counting...';
            animateCounting(className);
        });
    };

    const animateCounting = (className) => {
        const election = getActiveElection();
        const votes = election.votes[className];
        const totalVotes = votes.length;
        let i = 0;

        const interval = setInterval(() => {
            if (i >= totalVotes) {
                clearInterval(interval);
                document.getElementById('counting-status').textContent = 'Counting Complete!';
                showResultModal(className);
                return;
            }

            const vote = votes[i];
            const candidateId = vote.candidateId.toString();
            document.getElementById('counting-status').textContent = `Counting vote ${i + 1} of ${totalVotes}`;

            const candidateCard = document.querySelector(`.candidate-result-item[data-candidate-id='${candidateId}']`);
            
            if (candidateCard) {
                const voteEl = document.createElement('div');
                voteEl.innerHTML = '🗳️';
                voteEl.className = 'counting-vote';
                document.body.appendChild(voteEl);
                const rect = candidateCard.getBoundingClientRect();
                voteEl.style.left = (window.innerWidth / 2) + 'px';
                voteEl.style.top = (window.innerHeight - 50) + 'px';
                
                setTimeout(() => {
                    voteEl.style.transform = `translate(${rect.left - window.innerWidth/2 + rect.width/2}px, ${rect.top - window.innerHeight + 50}px) scale(1.5)`;
                    voteEl.style.opacity = 0;
                }, 50);

                setTimeout(() => {
                    voteEl.remove();
                    const currentVotes = parseInt(candidateCard.dataset.votes) + 1;
                    candidateCard.dataset.votes = currentVotes;
                    document.getElementById(`vote-count-${candidateId}`).textContent = currentVotes;
                    const percentage = totalVotes > 0 ? (currentVotes / totalVotes) * 100 : 0;
                    candidateCard.querySelector('.bg-blue-600').style.width = `${percentage}%`;
                    const list = document.getElementById('counting-candidate-list');
                    const items = Array.from(list.children);
                    items.sort((a, b) => parseInt(b.dataset.votes) - parseInt(a.dataset.votes));
                    items.forEach(item => list.appendChild(item));
                }, 500);
            }

            i++;
        }, 1000);
    };

    const showResultModal = (className) => {
        const election = getActiveElection();
        let candidates = election.candidates.filter(c => c.class === className);
        const votes = election.votes[className];
        const results = {};
        candidates.forEach(c => results[c.id] = { ...c, count: 0 });
        
        let notaVotes = 0;
        votes.forEach(v => {
            if (v.candidateId === 'NOTA') {
                notaVotes++;
            } else if (results[v.candidateId]) {
                results[v.candidateId].count++;
            }
        });

        let sortedResults = Object.values(results).sort((a, b) => b.count - a.count);
        let winner = sortedResults.length > 0 ? sortedResults[0] : null;
        let isDraw = winner && sortedResults.length > 1 && sortedResults[0].count === sortedResults[1].count && sortedResults[0].count > 0;
        
        election.classStatus[className] = { status: 'counted' };
        
        if (isDraw) {
            const tiedCandidates = sortedResults.filter(c => c.count === winner.count);
            const body = `
                <div id="draw-container" class="text-center">
                    <h2 class="text-2xl font-bold text-red-600">It's a Draw!</h2>
                    <p class="my-2">The following candidates have tied:</p>
                    <ul class="list-disc list-inside mb-4">
                        ${tiedCandidates.map(c => `<li><strong>${c.name}</strong> (${c.count} votes)</li>`).join('')}
                    </ul>
                    <p>Do you want to select a winner randomly?</p>
                </div>
            `;

            showModal({
                title: `Tie Breaker for Class ${className}`,
                body: body,
                confirmText: 'Yes, Select Winner',
                onConfirm: () => {
                    const randomIndex = Math.floor(Math.random() * tiedCandidates.length);
                    const finalWinner = tiedCandidates[randomIndex];
                    election.classStatus[className].winnerId = finalWinner.id;
                    saveState();
                    showWinnerModal(className, finalWinner, sortedResults, notaVotes, true);
                },
                cancelText: 'Close',
                onCancel: () => {
                    renderCountingClassSelection();
                    showView('counting-class-selection-view');
                }
            });

        } else {
            if (winner) {
                election.classStatus[className].winnerId = winner.id;
            }
            saveState();
            showWinnerModal(className, winner, sortedResults, notaVotes, false);
        }
    };

    const showWinnerModal = (className, winner, sortedResults, notaVotes, wasTie) => {
        const election = getActiveElection();
        const totalVotes = election.votes[className].length;
        let tieBreakerMessage = wasTie ? `<p class="text-sm text-yellow-600 font-semibold">(Won by random tie-breaker)</p>` : '';
        
        let voteLead = '';
        if (winner && sortedResults.length > 1) {
            const lead = sortedResults[0].count - sortedResults[1].count;
            if (lead > 0) {
                voteLead = `<p class="text-md mt-1">(Lead by ${lead} vote${lead > 1 ? 's' : ''})</p>`;
            }
        }

        let body = '';
        if (winner && winner.count > 0) {
             body = `
                <div class="text-center">
                    <img id="winner-img" src="" class="w-32 h-32 mx-auto rounded-full object-cover border-4 border-green-400 bg-gray-200">
                    <h2 class="text-2xl font-bold mt-4">Congratulations, ${winner.name}!</h2>
                    ${tieBreakerMessage}
                    <p class="text-lg text-gray-700">Selected as the representative for Class ${className}.</p>
                    <p class="text-xl font-semibold mt-2">${winner.count} Votes (${totalVotes > 0 ? ((winner.count/totalVotes)*100).toFixed(1) : 0}%)</p>
                    ${voteLead}
                </div>
            `;
        } else {
             body = `<h2 class="text-2xl font-bold text-center">No Winner Declared</h2><p class="text-center mt-2">No votes were cast for any candidate.</p>`;
        }
        
        body += '<hr class="my-4"><h4 class="font-bold mb-2">Full Results:</h4>';
        sortedResults.forEach(r => {
            body += `<p>${r.name}: ${r.count} votes</p>`;
        });
        if (election.includeNota) {
            body += `<p>NOTA: ${notaVotes} votes</p>`;
        }

        showModal({
            title: `Results for Class ${className}`,
            body: body,
            cancelText: 'OK',
            onCancel: () => {
                renderCountingClassSelection();
                showView('counting-class-selection-view');
            }
        });

        if (winner) {
            const imgElement = document.getElementById('winner-img');
            if (winner.hasImage) {
                db.getImage(winner.id).then(imageBlob => {
                    if(imageBlob) imgElement.src = URL.createObjectURL(imageBlob);
                });
            } else {
                const gender = winner.gender?.toLowerCase() || '';
                imgElement.src = gender.startsWith('f') ? femaleIcon : maleIcon;
            }
        }
    }
    
    // --- STEP 12: REPORTS ---
    const renderReportsView = () => {
        const election = getActiveElection();
        const container = document.getElementById('reports-view');
        container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Election Reports</h2>
            <button id="back-to-dash-3" class="mb-4 bg-gray-500 text-white p-2 rounded">Back to Dashboard</button>
            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <p>Generate PDF reports for the election: <strong>${election.name}</strong></p>
                <div class="flex flex-col space-y-3">
                    <button id="report-candidates-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg">Generate Candidate List</button>
                    <button id="report-winners-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Generate Winner's List</button>
                    <button id="report-detailed-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">Generate Detailed Report</button>
                </div>
            </div>
        `;
        container.querySelector('#back-to-dash-3').addEventListener('click', () => showView('admin-dashboard-view'));
        document.getElementById('report-candidates-btn').addEventListener('click', generateCandidateListReport);
        document.getElementById('report-winners-btn').addEventListener('click', generateWinnersReport);
        document.getElementById('report-detailed-btn').addEventListener('click', generateDetailedReport);
    };

    const generateCandidateListReport = async () => {
        const election = getActiveElection();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`${appData.school.name} - Candidate List`, 14, 22);
        doc.setFontSize(12);
        doc.text(`Report for: ${election.name}`, 14, 30);
        let startY = 40;

        const candidatesByClass = election.candidates.reduce((acc, c) => {
            if (!acc[c.class]) acc[c.class] = [];
            acc[c.class].push(c);
            return acc;
        }, {});

        for (const className of Object.keys(candidatesByClass).sort()) {
            doc.setFontSize(14);
            doc.text(`Class: ${className}`, 14, startY);
            startY += 7;

            const tableData = [];
            for(const c of candidatesByClass[className]) {
                let imageSrc = '';
                if (c.hasImage) {
                    const imageBlob = await db.getImage(c.id);
                    if (imageBlob) {
                        const reader = new FileReader();
                        await new Promise(resolve => {
                            reader.onload = (e) => {
                                imageSrc = e.target.result;
                                resolve();
                            };
                            reader.readAsDataURL(imageBlob);
                        });
                    }
                } else {
                    const gender = c.gender?.toLowerCase() || '';
                    imageSrc = gender.startsWith('f') ? femaleIcon : maleIcon;
                }
                tableData.push([{ content: '', image: imageSrc, width: 10 }, c.name, c.gender]);
            }
            
            doc.autoTable({
                head: [['Photo', 'Candidate Name', 'Gender']],
                body: tableData,
                startY: startY,
                theme: 'grid',
                columnStyles: { 0: { cellWidth: 15 } },
                didParseCell: function (data) {
                    if (data.section === 'body') {
                        data.cell.styles.minCellHeight = 15;
                    }
                },
                didDrawCell: (data) => {
                    if (data.column.index === 0 && data.cell.section === 'body' && data.cell.raw.image) {
                        const imgData = data.cell.raw.image;
                        const y = data.cell.y + (data.cell.height - 10) / 2;
                        doc.addImage(imgData, 'PNG', data.cell.x + 2.5, y, 10, 10);
                    }
                }
            });
            startY = doc.lastAutoTable.finalY + 15;
        }

        doc.save(`Candidate_List_${election.name}.pdf`);
    };

    const generateWinnersReport = () => {
        const election = getActiveElection();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`${appData.school.name} - Election Winners`, 14, 22);
        doc.setFontSize(12);
        doc.text(`Report for: ${election.name}`, 14, 30);

        const tableData = [];
        const headers = [['Class', 'Representative', 'Votes Received']];

        Object.keys(appData.classes).sort().forEach(className => {
            const classInfo = election.classStatus[className];
            if (classInfo?.status === 'counted') {
                const winnerId = classInfo.winnerId;
                const winner = election.candidates.find(c => c.id === winnerId);
                
                if (winner) {
                    const votes = election.votes[className] || [];
                    const winnerVoteCount = votes.filter(v => v.candidateId == winner.id).length;
                    
                    const tiedCandidates = election.candidates
                        .filter(c => c.class === className)
                        .map(c => ({
                            name: c.name,
                            count: votes.filter(v => v.candidateId == c.id).length
                        }))
                        .filter(c => c.count === winnerVoteCount);

                    let winnerName = winner.name;
                    if (tiedCandidates.length > 1) {
                        winnerName += " (Won by Tie-Breaker)";
                    }

                    tableData.push([
                        className,
                        winnerName,
                        winnerVoteCount
                    ]);
                } else {
                     tableData.push([ className, "No Winner", "N/A"]);
                }
            }
        });

        doc.autoTable({
            head: headers,
            body: tableData,
            startY: 40
        });

        doc.save(`Winners_Report_${election.name}.pdf`);
    };

    const generateDetailedReport = () => {
        const election = getActiveElection();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`${appData.school.name} - Detailed Election Report`, 14, 22);
        doc.setFontSize(12);
        doc.text(`Report for: ${election.name}`, 14, 30);
        let startY = 40;

        Object.keys(appData.classes).sort().forEach(className => {
            const classInfo = election.classStatus[className];
            if (classInfo?.status === 'counted') {
                const totalVoters = appData.classes[className].length;
                const votes = election.votes[className] || [];
                const totalVotesCast = votes.length;
                const votePercentage = totalVoters > 0 ? ((totalVotesCast / totalVoters) * 100).toFixed(1) : 0;
                
                doc.setFontSize(14);
                doc.text(`Class: ${className}`, 14, startY);
                startY += 7;
                doc.setFontSize(10);
                doc.text(`Total Students: ${totalVoters} | Votes Cast: ${totalVotesCast} (${votePercentage}%)`, 14, startY);
                startY += 5;

                const candidates = election.candidates.filter(c => c.class === className);
                const results = {};
                candidates.forEach(c => results[c.id] = { ...c, count: 0 });
                let notaVotes = 0;
                votes.forEach(v => {
                    if (v.candidateId === 'NOTA') {
                        notaVotes++;
                    } else if (results[v.candidateId]) {
                        results[v.candidateId].count++;
                    }
                });
                const sorted = Object.values(results).sort((a,b) => b.count - a.count);
                
                const tableData = sorted.map(c => [
                    c.name,
                    c.count,
                    totalVotesCast > 0 ? ((c.count / totalVotesCast) * 100).toFixed(1) + '%' : '0%'
                ]);

                if (election.includeNota) {
                    tableData.push(['NOTA', notaVotes, totalVotesCast > 0 ? ((notaVotes / totalVotesCast) * 100).toFixed(1) + '%' : '0%']);
                }

                doc.autoTable({
                    head: [['Candidate', 'Votes', 'Vote Share']],
                    body: tableData,
                    startY: startY,
                    theme: 'grid'
                });
                
                startY = doc.lastAutoTable.finalY + 15;
            }
        });

        doc.save(`Detailed_Report_${election.name}.pdf`);
    };
    
    // --- INSTRUCTIONS AND SAMPLE DATA ---
    document.getElementById('instructions-btn').addEventListener('click', () => {
        const instructionsHTML = `
            <div class="text-left text-sm space-y-3">
                <p>Follow these steps to conduct a successful election:</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li><strong>Setup School:</strong> After logging in, enter your official school code to load the school name.</li>
                    <li><strong>Upload Student Data:</strong>
                        <ul class="list-disc list-inside ml-4">
                            <li>Click "Download Sample File" to get a template.</li>
                            <li>Fill the Excel file with your student data. The headers must be <strong>name, class, gender</strong>.</li>
                            <li>Click "Choose File" and select your completed Excel file. A progress bar will show the import status.</li>
                        </ul>
                    </li>
                    <li><strong>Create & Manage Elections:</strong> Create one or more elections. You can edit or delete them before voting starts. Select an election to make it active for adding candidates and voting.</li>
                    <li><strong>Add & Manage Candidates:</strong> For the active election, add candidates. You can delete them from the list before voting for their class begins.</li>
                    <li><strong>Start Voting:</strong>
                        <ul class="list-disc list-inside ml-4">
                            <li>Go to "Start Voting" and select a class.</li>
                            <li>Enter the election password. The screen will go into fullscreen mode.</li>
                            <li>The voter uses the mouse to click on their chosen candidate. A beep will confirm the vote.</li>
                            <li>The admin (you) presses the <strong>TAB</strong> key to advance to the next voter.</li>
                            <li>After the last student has voted, the admin presses the <strong>ESC</strong> key and enters the password to end the session for that class.</li>
                        </ul>
                    </li>
                    <li><strong>Start Counting:</strong> Once voting is complete, go to "Start Counting" and select a class. If there is a draw, a winner will be chosen automatically by a random tie-breaker.</li>
                    <li><strong>View Reports:</strong> After all classes are counted, go to "View Reports" to generate and download detailed PDF reports.</li>
                    <li><strong>Data Management:</strong> Use the "Export Data" button to save a backup of all your election data. Use "Import Data" on another computer to load this backup and continue your work.</li>
                </ol>
                <p class="font-bold mt-4">Important: All data is saved in your browser's local storage. It is not sent online. Clearing your browser's cache may erase the data.</p>
            </div>
        `;
        showModal({
            title: 'How to Use the Election System',
            body: instructionsHTML,
            cancelText: 'Close'
        });
    });

    document.getElementById('download-sample-btn').addEventListener('click', () => {
        const sampleData = [
            { name: "John Doe", class: "10 A", gender: "Male" },
            { name: "Jane Smith", class: "10 A", gender: "Female" },
            { name: "Peter Jones", class: "9 B", gender: "Male" }
        ];
        const worksheet = XLSX.utils.json_to_sheet(sampleData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
        XLSX.writeFile(workbook, "student_data_sample.xlsx");
    });

    // --- DATA MANAGEMENT ---
    document.getElementById('export-data-btn').addEventListener('click', () => {
        try {
            const dataStr = JSON.stringify(appData);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `election_data_backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showModal({ title: 'Success', body: 'Data exported successfully.', cancelText: 'OK' });
        } catch (error) {
            showModal({ title: 'Error', body: 'Could not export data.', cancelText: 'OK' });
        }
    });

    document.getElementById('import-data-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                showModal({
                    title: 'Confirm Import',
                    body: 'Are you sure you want to import this data? This will overwrite all current election data.',
                    confirmText: 'Import',
                    onConfirm: () => {
                        appData = importedData;
                        saveState();
                        window.location.reload();
                    }
                });
            } catch (error) {
                showModal({ title: 'Error', body: 'Invalid or corrupted data file.', cancelText: 'OK' });
            }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset input
    });


    // --- INITIAL LOAD ---
    const initializeApp = async () => {
        try {
            await db.init();
            const response = await fetch('schools.json');
            if (!response.ok) {
                document.body.innerHTML = `<div class="p-8 text-center text-red-600">
                    <h1 class="text-2xl font-bold">Error: Could not load configuration file.</h1>
                    <p>Please make sure a valid <strong>schools.json</strong> file is in the same folder as this HTML file and that you are running this from a local web server.</p>
                </div>`;
                throw new Error('Failed to load schools.json');
            }
            schoolsData = await response.json();
            loadState();

            if (!localStorage.getItem('welcomeMessageShown')) {
                showModal({
                    title: 'IMPORTANT MESSAGE',
                    body: 'This application saves all data locally in your browser. No data is sent online. Please do not clear your browser history or cache for this site, as it will permanently delete all your election data. Use the "Export Data" feature to create backups.',
                    cancelText: 'I Understand',
                    onCancel: () => {
                        localStorage.setItem('welcomeMessageShown', 'true');
                    }
                });
            }

        } catch (error) {
            console.error(error);
        }
    };
    
    initializeApp();
    renderElectionForm();

});
</script>
</body>
</html>
