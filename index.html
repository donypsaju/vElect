<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline School Election System - Pro Edition</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Image Cropping -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --slate-950: #020617;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            scrollbar-gutter: stable;
            background-color: var(--slate-950);
            color: #f1f5f9;
        }

        .view { display: none; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .active-view { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Material Modals */
        .modal-backdrop { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(12px); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 1000; 
        }
        .modal-content { 
            background-color: var(--slate-900); 
            color: #f8fafc; 
            padding: 2.5rem; 
            border-radius: 2rem; 
            border: 1px solid #334155; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); 
            width: 95%; 
            max-width: 680px; 
            display: flex; 
            flex-direction: column; 
            max-height: 90vh; 
        }
        .modal-body { overflow-y: auto; padding-right: 0.5rem; }
        
        /* Form Styling */
        .input-dark { 
            background-color: #020617; 
            border: 1px solid #334155; 
            color: #f1f5f9; 
            transition: all 0.2s ease;
        }
        .input-dark:focus { 
            border-color: #3b82f6; 
            outline: none; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); 
        }

        /* Voting Animations */
        .counting-vote { 
            animation: flyToCandidate 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
            position: absolute; 
            font-size: 3rem; 
            z-index: 100; 
            pointer-events: none; 
        }
        @keyframes flyToCandidate { 
            0% { transform: scale(1) translateY(0); opacity: 1; } 
            100% { transform: scale(2.5) translateY(-200px); opacity: 0; } 
        }

        /* Layout Constraints */
        #candidate-cards { 
            display: grid; 
            gap: 1.5rem; 
            place-items: center; 
            height: calc(100vh - 250px); 
            padding: 1.5rem; 
            overflow: hidden;
        }
        
        .cropper-container { 
            max-height: 450px; 
            width: 100%; 
            background: #000; 
            overflow: hidden; 
            border-radius: 1rem; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        kbd {
            background: #334155;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
            color: #fff;
        }
    </style>
</head>
<body class="selection:bg-blue-500/40">

    <div id="app-container" class="container mx-auto p-4 max-w-7xl">
        <!-- Navigation Header -->
        <header class="bg-slate-900/60 backdrop-blur-xl border border-slate-800 shadow-2xl rounded-[2rem] p-5 mb-10 flex justify-between items-center sticky top-6 z-50">
            <div class="flex items-center space-x-4 cursor-pointer group" onclick="location.reload()">
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-2.5 rounded-xl shadow-lg group-hover:rotate-3 transition-transform">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                    <h1 id="header-title" class="text-lg font-black tracking-tighter text-white uppercase leading-none">Election Portal</h1>
                    <span class="text-[10px] text-slate-500 font-bold tracking-[0.2em] uppercase">V2.5 Offline Pro</span>
                </div>
            </div>
            <div id="header-buttons" class="flex items-center space-x-4">
                <button id="instructions-btn" class="hidden bg-slate-800 hover:bg-slate-700 text-slate-200 text-sm font-black py-2.5 px-6 rounded-xl border border-slate-700 transition-all">GUIDE</button>
                <button id="logout-button" class="hidden bg-rose-600/10 hover:bg-rose-600 text-rose-500 hover:text-white text-sm font-black py-2.5 px-6 rounded-xl border border-rose-500/20 transition-all shadow-xl">LOGOUT</button>
            </div>
        </header>

        <!-- Dynamic Content Engine -->
        <main id="main-content">
            
            <!-- VIEW: HOMEPAGE (Landing) -->
            <div id="homepage-view" class="view active-view">
                <div class="max-w-5xl mx-auto text-center py-20">
                    <span class="bg-blue-500/10 text-blue-400 text-xs font-black px-4 py-2 rounded-full border border-blue-500/20 uppercase tracking-widest mb-6 inline-block">Enterprise Voting Solutions</span>
                    <h1 class="text-7xl font-black text-white mb-8 tracking-tighter leading-none">The Future of <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">Classroom Democracy.</span></h1>
                    <p class="text-xl text-slate-400 leading-relaxed mb-12 max-w-2xl mx-auto font-medium">A high-performance, air-gapped election system. No cloud syncing, no data leakage, total privacy.</p>
                    <button id="goto-login-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-5 px-16 rounded-[2rem] text-xl shadow-2xl shadow-blue-900/40 transition transform hover:-translate-y-1 active:scale-95 uppercase tracking-widest">Access Control Panel</button>
                </div>

                <div class="grid lg:grid-cols-3 gap-8 mt-12">
                    <div class="bg-slate-900 p-10 rounded-[2.5rem] border border-slate-800 shadow-xl transition hover:border-blue-500/30">
                        <div class="text-blue-500 mb-8 bg-blue-500/10 w-14 h-14 rounded-2xl flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-black mb-4">Total Isolation</h3>
                        <p class="text-slate-400 leading-relaxed font-medium">Data is confined to your browser's IndexedDB. We never track, upload, or store your voters in the cloud.</p>
                    </div>
                    <div class="bg-slate-900 p-10 rounded-[2.5rem] border border-slate-800 shadow-xl transition hover:border-indigo-500/30">
                        <div class="text-indigo-500 mb-8 bg-indigo-500/10 w-14 h-14 rounded-2xl flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-black mb-4">Ballot Intelligence</h3>
                        <p class="text-slate-400 leading-relaxed font-medium">Built-in image processing ensures every candidate portrait is perfectly formatted for clarity during voting.</p>
                    </div>
                    <div class="bg-slate-900 p-10 rounded-[2.5rem] border border-slate-800 shadow-xl transition hover:border-emerald-500/30">
                        <div class="text-emerald-500 mb-8 bg-emerald-500/10 w-14 h-14 rounded-2xl flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-black mb-4">Rapid Tallies</h3>
                        <p class="text-slate-400 leading-relaxed font-medium">Automatic counting animations with real-time progress bars eliminate human error and manual counting stress.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: LOGIN -->
            <div id="login-view" class="view max-w-md mx-auto bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl">
                <h2 class="text-4xl font-black text-center mb-10 tracking-tight">System Login</h2>
                <div class="space-y-5">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Username</label>
                        <input id="admin-user" type="text" class="w-full p-4 rounded-2xl input-dark text-lg font-bold" value="admin">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Pin / Password</label>
                        <input id="admin-pass" type="password" class="w-full p-4 rounded-2xl input-dark text-lg font-bold" value="admin123">
                    </div>
                    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-900/30 transition-all mt-6 active:scale-95">AUTHORIZE ACCESS</button>
                </div>
            </div>

            <!-- VIEW: INSTITUTION SETUP -->
            <div id="school-setup-view" class="view max-w-lg mx-auto bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl">
                <h2 class="text-4xl font-black mb-4 tracking-tight text-center">Identity Setup</h2>
                <p class="mb-10 text-slate-400 text-center font-medium leading-relaxed">Please link this portal to your educational institution.</p>
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-widest ml-1">Institution Code (Optional Lookup)</label>
                        <input id="school-code-input" type="text" placeholder="e.g. 01139" class="w-full p-4 rounded-2xl input-dark font-bold text-lg">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-widest ml-1">Full Institution Name <span class="text-blue-500">*</span></label>
                        <input id="school-name-input" type="text" placeholder="e.g. Govt. H S S Aruvikkara" class="w-full p-4 rounded-2xl input-dark font-bold text-lg">
                    </div>
                </div>
                <button id="confirm-school-btn" class="w-full mt-12 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all active:scale-95">INITIALIZE SUITE</button>
                <button id="report-missing-school-btn" class="mt-8 w-full text-sm text-slate-500 hover:text-blue-400 transition font-bold underline decoration-slate-700">Missing from lookup?</button>
            </div>

            <!-- VIEW: ADMIN DASHBOARD -->
            <div id="admin-dashboard-view" class="view">
                <div class="flex items-end justify-between mb-12 border-b border-slate-800 pb-8">
                    <div>
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-[0.3em]">Active Institution</span>
                        <h2 class="text-5xl font-black text-white tracking-tighter mt-2" id="dashboard-school-name"></h2>
                    </div>
                    <div class="flex space-x-4">
                        <button id="export-data-btn" class="bg-slate-900 hover:bg-slate-800 text-slate-300 p-4 rounded-2xl border border-slate-800 transition" title="Export Backup">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4-4m4 4v12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Column 1: Population Management -->
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-xl flex flex-col">
                        <h3 class="text-xl font-black mb-8 flex items-center text-white"><span class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center mr-4 text-sm">1</span> REGISTER</h3>
                        <p class="text-slate-400 text-sm mb-10 leading-relaxed flex-grow font-medium">Populate your voter database using our Excel integration.</p>
                        <div class="space-y-4">
                            <input type="file" id="student-file-input" accept=".xlsx, .xls" class="w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-full file:border-0 file:text-xs file:font-black file:bg-blue-600/10 file:text-blue-400 hover:file:bg-blue-600/20 cursor-pointer"/>
                            <button id="download-sample-btn" class="w-full bg-slate-950 hover:bg-slate-800 text-slate-300 font-black py-4 rounded-2xl border border-slate-800 transition shadow-inner">GET TEMPLATE</button>
                        </div>
                        <div id="student-data-status" class="mt-6 text-emerald-400 font-black text-[10px] uppercase tracking-widest text-center"></div>
                    </div>

                    <!-- Column 2: Session Config -->
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-xl">
                        <h3 id="election-form-title" class="text-xl font-black mb-8 flex items-center text-white"><span class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center mr-4 text-sm">2</span> CONFIGURE</h3>
                        <div class="space-y-4">
                            <input id="election-name" type="text" placeholder="Session Title" class="w-full p-4 rounded-2xl input-dark font-bold">
                            <input id="election-password" type="password" placeholder="Booth Security PIN" class="w-full p-4 rounded-2xl input-dark font-bold">
                            <label class="flex items-center space-x-3 cursor-pointer bg-slate-950/80 p-4 rounded-2xl border border-slate-800 transition hover:border-slate-700">
                                <input id="include-nota" type="checkbox" class="w-6 h-6 rounded-lg border-slate-700 bg-slate-950 text-blue-600 focus:ring-blue-600 focus:ring-offset-slate-950">
                                <span class="text-sm text-slate-400 font-bold">Ballot NOTA Option</span>
                            </label>
                            <div id="election-form-buttons">
                                <button id="create-election-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl transition-all">INITIALIZE SESSION</button>
                            </div>
                        </div>
                    </div>

                    <!-- Column 3: Vault -->
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-xl flex flex-col">
                        <h3 class="text-xl font-black mb-8 text-white">ELECTION VAULT</h3>
                        <div id="election-list" class="space-y-4 overflow-y-auto max-h-[350px] pr-2"></div>
                    </div>
                </div>

                <!-- Section: Management of Active Election -->
                <div id="active-election-section" class="mt-16 space-y-12 hidden animate-fadeIn">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <!-- Candidate Setup -->
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800">
                            <h3 class="text-2xl font-black mb-10 flex items-center text-white"><span class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center mr-4 text-sm">3</span> CANDIDATES</h3>
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <select id="candidate-class-select" class="w-full p-4 rounded-2xl input-dark font-bold"></select>
                                    <select id="candidate-name-select" class="w-full p-4 rounded-2xl input-dark font-bold"></select>
                                </div>
                                <input id="candidate-gender" type="text" placeholder="Gender Profile" class="w-full p-4 rounded-2xl input-dark opacity-40 font-bold" readonly>
                                <div class="bg-slate-950 p-6 rounded-2xl border border-slate-800">
                                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4">Voter Identity Portrait</label>
                                    <input type="file" id="candidate-image-input" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-full file:border-0 file:text-xs file:font-black file:bg-blue-600/10 file:text-blue-400 hover:file:bg-blue-600/20 cursor-pointer"/>
                                </div>
                                <button id="add-candidate-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase tracking-widest">Register on Ballot</button>
                            </div>
                        </div>

                        <!-- Ballot View -->
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800">
                            <h3 class="text-2xl font-black mb-10 text-white">LIVE BALLOT PREVIEW</h3>
                            <div id="candidate-list" class="space-y-6 max-h-[500px] overflow-y-auto pr-3"></div>
                        </div>
                    </div>

                    <!-- Operational Hub -->
                    <div class="bg-gradient-to-br from-blue-600/10 to-indigo-600/10 p-10 rounded-[3.5rem] border border-blue-500/20 shadow-2xl">
                        <h3 class="text-2xl font-black mb-10 flex items-center text-white"><span class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center mr-4 text-sm font-black">4</span> MISSION CONTROL</h3>
                        <div class="grid sm:grid-cols-3 gap-8">
                            <button id="goto-voting-btn" class="group bg-blue-600 hover:bg-blue-500 text-white font-black py-8 rounded-3xl transition shadow-2xl shadow-blue-900/40 text-xl uppercase tracking-widest relative overflow-hidden">
                                <span class="relative z-10">OPEN BOOTH</span>
                                <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                            </button>
                            <button id="goto-counting-btn" class="group bg-indigo-600 hover:bg-indigo-500 text-white font-black py-8 rounded-3xl transition shadow-2xl shadow-indigo-900/40 text-xl uppercase tracking-widest relative overflow-hidden">
                                <span class="relative z-10">BEGIN TALLY</span>
                                <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
                            </button>
                            <button id="goto-reports-btn" class="bg-slate-800 hover:bg-slate-700 text-white font-black py-8 rounded-3xl border border-slate-700 transition text-xl uppercase tracking-widest">AUDIT REPORTS</button>
                        </div>
                    </div>
                </div>

                <!-- Restore Block -->
                <div class="mt-16 bg-slate-900/20 p-10 rounded-[3rem] border-2 border-dashed border-slate-800 flex items-center justify-center space-x-6">
                    <p class="text-slate-500 font-bold text-sm uppercase tracking-widest">Disaster Recovery:</p>
                    <label for="import-data-input" class="bg-slate-900 hover:bg-slate-800 text-slate-400 py-3 px-10 rounded-2xl border border-slate-800 transition font-black cursor-pointer shadow-lg">IMPORT BACKUP VAULT</label>
                    <input type="file" id="import-data-input" class="hidden" accept=".json">
                </div>
            </div>
            
            <!-- VIEW: VOTING SELECTION -->
            <div id="voting-class-selection-view" class="view p-10">
                <div class="flex items-center justify-between mb-10">
                    <h2 class="text-4xl font-black text-white">Selection Hub</h2>
                    <button onclick="showView('admin-dashboard-view')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 px-8 rounded-2xl border border-slate-700 transition font-black">EXIT HUB</button>
                </div>
                <div id="voter-selection-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
            </div>

            <!-- VIEW: VOTING SCREEN -->
            <div id="voting-screen-view" class="view h-screen fixed inset-0 z-[100] bg-slate-950" oncontextmenu="return false;">
                <div class="flex flex-col h-full">
                    <div class="text-center py-10 bg-slate-900/50 border-b border-slate-800">
                        <h2 id="booth-title" class="text-6xl font-black text-blue-400 mb-4 tracking-tighter"></h2>
                        <p id="voter-counter" class="text-2xl text-slate-500 font-black tracking-widest"></p>
                    </div>
                    <div id="candidate-cards" class="flex-grow p-10"></div>
                    <div class="py-6 text-center text-slate-700 font-black uppercase text-xs tracking-[0.5em]">Digital Voting Booth Protocol v2.5</div>
                </div>
            </div>

            <!-- VIEW: COUNTING SELECTION -->
            <div id="counting-class-selection-view" class="view p-10">
                <div class="flex items-center justify-between mb-10">
                    <h2 class="text-4xl font-black text-white">Tally Selection</h2>
                    <button onclick="showView('admin-dashboard-view')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 px-8 rounded-2xl border border-slate-700 transition font-black">EXIT HUB</button>
                </div>
                <div id="counting-selection-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
            </div>

            <!-- VIEW: COUNTING SCREEN -->
            <div id="counting-screen-view" class="view h-screen fixed inset-0 z-[100] bg-slate-950">
                <div class="flex flex-col h-full">
                    <div class="text-center py-10">
                        <h2 id="counting-header" class="text-6xl font-black text-indigo-400 mb-2 tracking-tighter"></h2>
                        <p id="counting-status" class="text-2xl text-slate-500 font-black"></p>
                        <button id="begin-counting-btn" class="mt-8 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 px-16 rounded-2xl shadow-2xl transition transform hover:scale-105">COMMENCE COUNT</button>
                    </div>
                    <div id="counting-candidate-list" class="flex-grow overflow-hidden"></div>
                </div>
            </div>

            <!-- VIEW: REPORTS -->
            <div id="reports-view" class="view p-10">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-12">
                        <h2 class="text-4xl font-black text-white">Intelligence Center</h2>
                        <button onclick="showView('admin-dashboard-view')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 px-8 rounded-2xl border border-slate-700 transition font-black">DASHBOARD</button>
                    </div>
                    <div class="bg-slate-900 p-12 rounded-[3.5rem] border border-slate-800 shadow-2xl">
                        <p class="text-slate-400 font-bold mb-10 uppercase tracking-widest text-center">Certified Election Documentation</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <button id="report-candidates-btn" class="bg-slate-800 hover:bg-slate-700 text-white font-black py-8 rounded-3xl border border-slate-700 transition shadow-xl">BALLOT REGISTRY</button>
                            <button id="report-winners-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-8 rounded-3xl transition shadow-2xl shadow-blue-900/30">WINNERS LIST</button>
                            <button id="report-detailed-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-black py-8 rounded-3xl transition shadow-2xl shadow-indigo-900/30">FULL AUDIT</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- OVERLAY: CROPPER -->
    <div id="crop-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-xl">
            <h3 class="text-2xl font-black mb-6 flex items-center"><svg class="w-6 h-6 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>BALLOT PORTRAIT</h3>
            <div class="cropper-container"><img id="crop-image" src=""></div>
            <div class="mt-10 flex justify-between items-center">
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Force 1:1 Square Ratio</p>
                <div class="space-x-4">
                    <button id="crop-cancel" class="bg-slate-800 hover:bg-slate-700 px-8 py-3 rounded-xl font-bold border border-slate-700">Cancel</button>
                    <button id="crop-confirm" class="bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded-xl font-black shadow-xl">Apply Crop</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY: MESSAGE BOX -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-black mb-4 uppercase tracking-tighter"></h3>
            <div id="modal-body" class="modal-body text-slate-300 font-medium"></div>
            <div id="modal-footer" class="mt-10 flex justify-end space-x-4 pt-6 border-t border-slate-800/50">
                <button id="modal-cancel-btn" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-xl transition border border-slate-700">Cancel</button>
                <button id="modal-confirm-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-3 px-8 rounded-xl shadow-lg transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- OVERLAY: BUSY STATE -->
    <div id="progress-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-xs text-center">
            <h3 id="progress-title" class="text-xl font-black mb-8 uppercase tracking-widest">Processing</h3>
            <div id="progress-body">
                <div class="w-full bg-slate-950 rounded-full h-2 border border-slate-800 mb-6 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-[10px] text-slate-500 font-black uppercase tracking-widest"></p>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- APP STATE ---
    let appData = { school: null, students: [], classes: {}, elections: [], activeElectionId: null, currentVotingClass: null, currentVoterIndex: 0, loggedIn: false };
    let schoolsData = [];
    
    // Fallback Icons (Base64 transparent placeholders)
    const femaleIcon = 'female.png';
    const maleIcon = 'male.png';

    // --- DOM CACHE ---
    const views = document.querySelectorAll('.view');
    const headerTitle = document.getElementById('header-title');
    const headerButtons = document.getElementById('header-buttons');
    const logoutButton = document.getElementById('logout-button');
    const instructionsButton = document.getElementById('instructions-btn');

    // --- DB ENGINE ---
    const db = {
        instance: null,
        async init() {
            return new Promise((res, rej) => {
                const req = indexedDB.open('ElectionDB', 3);
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('candidate_images')) {
                        d.createObjectStore('candidate_images', { keyPath: 'id' });
                    }
                };
                req.onsuccess = (e) => { this.instance = e.target.result; res(); };
                req.onerror = (e) => rej(e.target.errorCode);
            });
        },
        async addImage(id, blob) {
            const tx = this.instance.transaction(['candidate_images'], 'readwrite');
            await tx.objectStore('candidate_images').put({ id, image: blob });
        },
        async getImage(id) {
            return new Promise(res => {
                const req = this.instance.transaction(['candidate_images'], 'readonly').objectStore('candidate_images').get(id);
                req.onsuccess = () => res(req.result?.image);
                req.onerror = () => res(null);
            });
        },
        async deleteImage(id) {
            this.instance.transaction(['candidate_images'], 'readwrite').objectStore('candidate_images').delete(id);
        }
    };

    // --- CROPPER LOGIC ---
    let cropperInstance = null;
    const cropModal = document.getElementById('crop-modal');
    const cropImage = document.getElementById('crop-image');
    
    document.getElementById('candidate-image-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            cropImage.src = ev.target.result;
            cropModal.classList.remove('hidden');
            if (cropperInstance) cropperInstance.destroy();
            cropperInstance = new Cropper(cropImage, { 
                aspectRatio: 1, 
                viewMode: 2, 
                autoCropArea: 1,
                dragMode: 'move',
                background: false
            });
        };
        reader.readAsDataURL(file);
    };

    document.getElementById('crop-cancel').onclick = () => {
        cropModal.classList.add('hidden');
        document.getElementById('candidate-image-input').value = null;
    };

    document.getElementById('crop-confirm').onclick = () => {
        const election = getActiveElection();
        if (!election) return;
        
        cropperInstance.getCroppedCanvas({ width: 500, height: 500 }).toBlob(async (blob) => {
            const id = Date.now().toString();
            const n = document.getElementById('candidate-name-select').value;
            const c = document.getElementById('candidate-class-select').value;
            const g = document.getElementById('candidate-gender').value;

            await db.addImage(id, blob);
            election.candidates.push({ id, name: n, class: c, gender: g, hasImage: true });
            saveState();
            cropModal.classList.add('hidden');
            renderCandidateList();
            document.getElementById('candidate-image-input').value = null;
        }, 'image/jpeg', 0.9);
    };

    // --- NAVIGATION ---
    const showView = (id) => {
        views.forEach(v => v.classList.remove('active-view'));
        document.getElementById(id).classList.add('active-view');
        
        const isSecure = !['homepage-view', 'login-view', 'school-setup-view'].includes(id);
        const isBooth = ['voting-screen-view', 'counting-screen-view'].includes(id);
        
        logoutButton.classList.toggle('hidden', !isSecure || !appData.loggedIn);
        instructionsButton.classList.toggle('hidden', !isSecure || !appData.loggedIn);
        headerButtons.classList.toggle('hidden', isBooth);
        headerTitle.textContent = appData.school ? appData.school.name : 'Election Portal';
    };

    const saveState = () => {
        const payload = { ...appData };
        payload.elections = appData.elections.map(el => {
            const elCopy = { ...el };
            elCopy.candidates = el.candidates.map(c => { const { image, ...rest } = c; return rest; });
            return elCopy;
        });
        localStorage.setItem('electionAppData', JSON.stringify(payload));
    };

    const loadState = () => {
        const saved = localStorage.getItem('electionAppData');
        if (saved) {
            appData = JSON.parse(saved);
            if (!Array.isArray(appData.elections)) appData.elections = [];
            if (appData.loggedIn) {
                if(appData.school) { showView('admin-dashboard-view'); renderAdminDashboard(); }
                else showView('school-setup-view');
            } else { showView('homepage-view'); }
        } else { showView('homepage-view'); }
    };

    const getActiveElection = () => appData.elections.find(e => e.id === appData.activeElectionId);

    const showModal = (cfg) => {
        const { title, body, onConfirm, confirmText = 'Confirm', onCancel, cancelText = 'Cancel', requiresInput = false } = cfg;
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = body;
        if (requiresInput) document.getElementById('modal-body').innerHTML += `<input type="password" id="modal-password-input" class="w-full p-4 mt-4 rounded-2xl input-dark text-center font-black text-2xl tracking-[0.5em]">`;
        const c = document.getElementById('modal-confirm-btn');
        const x = document.getElementById('modal-cancel-btn');
        c.textContent = confirmText; x.textContent = cancelText;
        if (onConfirm) {
            c.classList.remove('hidden');
            c.onclick = () => { onConfirm(document.getElementById('modal-password-input')?.value); document.getElementById('modal').classList.add('hidden'); };
        } else c.classList.add('hidden');
        x.onclick = () => { if (onCancel) onCancel(); document.getElementById('modal').classList.add('hidden'); };
        document.getElementById('modal').classList.remove('hidden');
    };

    // --- HANDLERS ---
    document.getElementById('goto-login-btn').onclick = () => showView('login-view');
    document.getElementById('login-btn').onclick = () => {
        if(document.getElementById('admin-user').value === 'admin' && document.getElementById('admin-pass').value === 'admin123') {
            appData.loggedIn = true;
            if(appData.school) { showView('admin-dashboard-view'); renderAdminDashboard(); }
            else showView('school-setup-view');
            saveState();
        } else showModal({ title: 'Auth Error', body: 'Access denied. Credentials do not match our secure records.', cancelText: 'Retry' });
    };

    document.getElementById('school-code-input').oninput = (e) => {
        const code = e.target.value.trim();
        const match = schoolsData.find(s => [s.school_code, s.hss_code, s.vhse_code].includes(code));
        if(match) document.getElementById('school-name-input').value = match.school_name;
    };

    document.getElementById('confirm-school-btn').onclick = () => {
        const n = document.getElementById('school-name-input').value.trim();
        const c = document.getElementById('school-code-input').value.trim();
        if(n) { appData.school = { code: c || 'N/A', name: n }; saveState(); showView('admin-dashboard-view'); renderAdminDashboard(); }
        else showModal({ title: 'Validation', body: 'Institution name is compulsory for system initialization.', cancelText: 'OK' });
    };

    // Election Creation
    document.getElementById('create-election-btn').onclick = () => {
        const n = document.getElementById('election-name').value.trim();
        const p = document.getElementById('election-password').value.trim();
        const i = document.getElementById('include-nota').checked;
        if(n && p) {
            appData.elections.push({ id: Date.now().toString(), name: n, password: p, includeNota: i, candidates: [], votes: {}, classStatus: {} });
            saveState(); renderAdminDashboard();
            document.getElementById('election-name').value = '';
            document.getElementById('election-password').value = '';
        } else showModal({ title: 'Config Error', body: 'Title and PIN are mandatory for session tracking.', cancelText: 'OK' });
    };

    // Nomination Handlers
    document.getElementById('candidate-class-select').onchange = (e) => {
        const cls = e.target.value;
        const nameSel = document.getElementById('candidate-name-select');
        nameSel.innerHTML = '<option value="">Select Student</option>';
        if(appData.classes[cls]) {
            appData.classes[cls].forEach(s => { nameSel.innerHTML += `<option value="${s.name}">${s.name}</option>`; });
        }
    };
    document.getElementById('candidate-name-select').onchange = (e) => {
        const cls = document.getElementById('candidate-class-select').value;
        const student = appData.classes[cls]?.find(s => s.name === e.target.value);
        document.getElementById('candidate-gender').value = student ? student.gender : '';
    };

    document.getElementById('add-candidate-btn').onclick = () => {
        const election = getActiveElection();
        const n = document.getElementById('candidate-name-select').value;
        const c = document.getElementById('candidate-class-select').value;
        const g = document.getElementById('candidate-gender').value;
        if(!n || !c) return showModal({ title: 'Missing Data', body: 'Select class and student name.', cancelText: 'OK' });
        
        if (document.getElementById('candidate-image-input').files.length === 0) {
            const id = Date.now().toString();
            election.candidates.push({ id, name: n, class: c, gender: g, hasImage: false });
            saveState(); renderCandidateList();
            showModal({ title: 'Success', body: `${n} added to ballot without portrait.`, cancelText: 'OK' });
        }
    };

    // --- DASHBOARD CORE ---
    function renderAdminDashboard() {
        document.getElementById('dashboard-school-name').textContent = appData.school?.name || 'Portal';
        if(appData.students.length) {
            document.getElementById('student-data-status').textContent = `${appData.students.length} VERIFIED VOTERS`;
            const sel = document.getElementById('candidate-class-select');
            sel.innerHTML = '<option value="">Select Class</option>';
            Object.keys(appData.classes).sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        }
        renderElectionList();
        const active = getActiveElection();
        document.getElementById('active-election-section').classList.toggle('hidden', !active);
        if(active) {
            document.getElementById('active-election-name').textContent = active.name;
            renderCandidateList();
        }
    }

    function renderElectionList() {
        const cont = document.getElementById('election-list');
        cont.innerHTML = appData.elections.map(e => `
            <div class="flex items-center justify-between p-4 rounded-2xl ${appData.activeElectionId === e.id ? 'bg-blue-600/20 border border-blue-500/40 shadow-[0_0_20px_rgba(59,130,246,0.1)]' : 'bg-slate-950 border border-slate-800'}">
                <div class="truncate mr-4">
                    <p class="font-black text-sm text-white">${e.name}</p>
                    <p class="text-[9px] text-slate-500 uppercase font-black tracking-widest mt-1">${e.candidates.length} CANDIDATES</p>
                </div>
                <div class="flex space-x-2">
                    <button class="px-4 py-1.5 rounded-xl text-[10px] font-black tracking-widest ${appData.activeElectionId === e.id ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}" onclick="selectElection('${e.id}')">${appData.activeElectionId === e.id ? 'ACTIVE' : 'SELECT'}</button>
                    <button class="p-2 rounded-xl bg-slate-900 text-rose-500 border border-slate-800" onclick="deleteElection('${e.id}')"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                </div>
            </div>`).join('');
    }

    window.selectElection = (id) => { appData.activeElectionId = id; saveState(); renderAdminDashboard(); };
    window.deleteElection = (id) => {
        showModal({
            title: 'Wipe Session?', body: 'Are you sure? All votes and data for this specific election will be permanently purged.', confirmText: 'WIPE DATA',
            onConfirm: () => {
                appData.elections = appData.elections.filter(e => e.id !== id);
                if(appData.activeElectionId === id) appData.activeElectionId = null;
                saveState(); renderAdminDashboard();
            }
        });
    };

    function renderCandidateList() {
        const el = getActiveElection();
        const cont = document.getElementById('candidate-list');
        const grouped = el.candidates.reduce((acc, c) => { if(!acc[c.class]) acc[c.class] = []; acc[c.class].push(c); return acc; }, {});
        cont.innerHTML = Object.keys(grouped).sort().map(cls => `
            <div class="bg-slate-950 p-5 rounded-3xl border border-slate-800 shadow-inner">
                <p class="text-indigo-400 text-[10px] font-black uppercase mb-4 tracking-[0.2em] border-b border-slate-900 pb-2">${cls}</p>
                <div class="space-y-3">
                    ${grouped[cls].map(c => `
                        <div class="flex justify-between items-center text-sm bg-slate-900/50 p-3 rounded-xl border border-slate-800/50">
                            <span class="font-bold text-slate-300">${c.name}</span>
                            <button class="text-rose-500/50 hover:text-rose-500 transition" onclick="removeCandidate('${c.id}')"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>`).join('')}
                </div>
            </div>`).join('');
    }

    window.removeCandidate = async (id) => {
        const el = getActiveElection();
        const c = el.candidates.find(x => x.id === id);
        if(c.hasImage) await db.deleteImage(id);
        el.candidates = el.candidates.filter(x => x.id !== id);
        saveState(); renderCandidateList();
    };

    // --- VOTING LOGIC ---
    document.getElementById('goto-voting-btn').onclick = () => {
        const el = getActiveElection();
        const grid = document.getElementById('voter-selection-grid');
        grid.innerHTML = Object.keys(appData.classes).sort().map(cls => {
            const isDone = el.classStatus[cls]?.status === 'voted' || el.classStatus[cls]?.status === 'counted';
            return `<button class="p-8 rounded-3xl font-black text-xl border-2 transition-all transform hover:scale-105 ${isDone ? 'bg-slate-900 border-slate-800 text-slate-600' : 'bg-blue-600 border-blue-500 text-white shadow-xl shadow-blue-900/30'}" onclick="initBooth('${cls}')">${cls}${isDone ? '<br><span class="text-[10px] opacity-40">LOCKED</span>' : ''}</button>`;
        }).join('');
        showView('voting-class-selection-view');
    };

    window.initBooth = (cls) => {
        const el = getActiveElection();
        if(el.classStatus[cls]?.status === 'voted') return showModal({ title: 'Access Denied', body: 'Voting for this class has already been finalized.', cancelText: 'OK' });
        showModal({ title: `Booth Access: ${cls}`, body: 'Enter Booth PIN to unlock terminal.', requiresInput: true, onConfirm: (pin) => {
            if(pin === el.password) {
                appData.currentVotingClass = cls;
                appData.currentVoterIndex = 0;
                if(!el.votes[cls]) el.votes[cls] = [];
                renderVotingScreen();
                showView('voting-screen-view');
                enterFullScreen(document.documentElement);
            } else showModal({ title: 'PIN Error', body: 'Authorization failed.', cancelText: 'Retry' });
        }});
    };

    async function renderVotingScreen() {
        const el = getActiveElection();
        const cls = appData.currentVotingClass;
        const total = appData.classes[cls].length;
        const candidates = el.candidates.filter(c => c.class === cls);
        const totalCards = candidates.length + (el.includeNota ? 1 : 0);
        
        let cols = totalCards > 9 ? 'grid-cols-5' : totalCards > 4 ? 'grid-cols-3' : 'grid-cols-2';
        document.getElementById('booth-title').textContent = `${cls} BALLOT`;
        document.getElementById('voter-counter').textContent = `VOTER SEQUENCE: ${appData.currentVoterIndex + 1} / ${total}`;
        
        const cardCont = document.getElementById('candidate-cards');
        cardCont.className = `grid ${cols} gap-6 max-w-6xl mx-auto items-center`;
        cardCont.innerHTML = candidates.map(c => `
            <div class="bg-slate-900 border-4 border-slate-800 p-8 rounded-[3rem] text-center cursor-pointer transition transform hover:scale-105 hover:border-blue-500 group" onclick="castVote('${c.id}')">
                <img id="ballot-img-${c.id}" src="" class="w-32 h-32 md:w-48 md:h-48 rounded-full mx-auto mb-6 object-cover border-4 border-slate-800 bg-slate-800">
                <h3 class="text-3xl font-black text-white group-hover:text-blue-400">${c.name}</h3>
            </div>
        `).join('') + (el.includeNota ? `
            <div class="bg-slate-900 border-4 border-slate-800 p-8 rounded-[3rem] text-center cursor-pointer transition transform hover:scale-105 hover:border-slate-500 group" onclick="castVote('NOTA')">
                <div class="w-32 h-32 md:w-48 md:h-48 rounded-full mx-auto mb-6 bg-slate-800 flex items-center justify-center border-4 border-slate-700">
                    <svg class="w-24 h-24 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                </div>
                <h3 class="text-3xl font-black text-slate-500">NOTA</h3>
            </div>` : '');

        for(const c of candidates) {
            const img = document.getElementById(`ballot-img-${c.id}`);
            if(c.hasImage) {
                const b = await db.getImage(c.id);
                if(b) img.src = URL.createObjectURL(b);
            } else {
                img.src = c.gender.toLowerCase().startsWith('f') ? femaleIcon : maleIcon;
            }
        }
    }

    window.castVote = (cid) => {
        const el = getActiveElection();
        const synth = new Tone.Synth().toDestination();
        synth.triggerAttackRelease("C4", "8n");
        
        el.votes[appData.currentVotingClass].push({ voter: appData.currentVoterIndex, cid });
        saveState();
        
        const overlay = document.getElementById('vote-cast-overlay');
        overlay.classList.remove('hidden');
    };

    // --- COUNTING LOGIC ---
    document.getElementById('goto-counting-btn').onclick = () => {
        const el = getActiveElection();
        const grid = document.getElementById('counting-selection-grid');
        grid.innerHTML = Object.keys(appData.classes).sort().map(cls => {
            const status = el.classStatus[cls]?.status;
            const canCount = status === 'voted';
            const isDone = status === 'counted';
            return `<button class="p-8 rounded-3xl font-black text-xl border-2 transition-all transform hover:scale-105 ${canCount ? 'bg-indigo-600 border-indigo-500 text-white shadow-xl shadow-indigo-900/30' : 'bg-slate-900 border-slate-800 text-slate-600'}" onclick="initCount('${cls}')">${cls}${isDone ? '<br><span class="text-[10px] opacity-40 uppercase">FINISHED</span>' : ''}</button>`;
        }).join('');
        showView('counting-class-selection-view');
    };

    window.initCount = (cls) => {
        const el = getActiveElection();
        if(el.classStatus[cls]?.status !== 'voted') return showModal({ title: 'Blocked', body: 'Voting must be finalized before counting can commence.', cancelText: 'OK' });
        
        document.getElementById('counting-header').textContent = `TALLY: ${cls}`;
        document.getElementById('counting-status').textContent = 'READY FOR AUDIT';
        
        const candidates = el.candidates.filter(c => c.class === cls);
        const totalItems = candidates.length + (el.includeNota ? 1 : 0);
        let cols = totalItems > 9 ? 'grid-cols-5' : totalItems > 4 ? 'grid-cols-3' : 'grid-cols-2';
        
        const list = document.getElementById('counting-candidate-list');
        list.className = `grid ${cols} gap-6 max-w-7xl mx-auto p-10`;
        list.innerHTML = candidates.map(c => `
            <div class="candidate-result-item flex flex-col items-center bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800" data-cid="${c.id}" data-votes="0">
                <img id="count-img-${c.id}" src="" class="w-24 h-24 rounded-full mb-6 object-cover border-4 border-slate-800">
                <p class="font-black text-white text-lg mb-4 text-center line-clamp-1">${c.name}</p>
                <div class="w-full bg-slate-950 h-3 rounded-full mb-6 overflow-hidden"><div class="progress-bar bg-indigo-500 h-full transition-all" style="width: 0%"></div></div>
                <p class="text-6xl font-black text-indigo-400 tally-num">0</p>
            </div>
        `).join('') + (el.includeNota ? `
            <div class="candidate-result-item flex flex-col items-center bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-800" data-cid="NOTA" data-votes="0">
                <div class="w-24 h-24 rounded-full mb-6 bg-slate-800 flex items-center justify-center border-4 border-slate-700 text-slate-600"><svg class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg></div>
                <p class="font-black text-slate-500 text-lg mb-4 uppercase">NOTA</p>
                <div class="w-full bg-slate-950 h-3 rounded-full mb-6 overflow-hidden"><div class="progress-bar bg-slate-700 h-full transition-all" style="width: 0%"></div></div>
                <p class="text-6xl font-black text-slate-600 tally-num">0</p>
            </div>` : '');

        candidates.forEach(async c => {
            const img = document.getElementById(`count-img-${c.id}`);
            if(c.hasImage) {
                const b = await db.getImage(c.id);
                if(b) img.src = URL.createObjectURL(b);
            } else img.src = c.gender.toLowerCase().startsWith('f') ? femaleIcon : maleIcon;
        });

        document.getElementById('begin-counting-btn').classList.remove('hidden');
        document.getElementById('begin-counting-btn').onclick = () => runTallyAnimation(cls);
        showView('counting-screen-view');
        enterFullScreen(document.documentElement);
    };

    function runTallyAnimation(cls) {
        const el = getActiveElection();
        const votes = el.votes[cls];
        const btn = document.getElementById('begin-counting-btn');
        btn.classList.add('hidden');
        
        let i = 0;
        const itv = setInterval(() => {
            if(i >= votes.length) {
                clearInterval(itv);
                document.getElementById('counting-status').textContent = 'AUDIT COMPLETE';
                setTimeout(() => { exitFullScreen(); finalizeResults(cls); }, 2000);
                return;
            }
            
            const v = votes[i];
            const card = document.querySelector(`[data-cid="${v.cid}"]`);
            if(card) {
                const val = parseInt(card.dataset.votes) + 1;
                card.dataset.votes = val;
                card.querySelector('.tally-num').textContent = val;
                card.querySelector('.progress-bar').style.width = `${(val/votes.length)*100}%`;
                
                const emoji = document.createElement('div');
                emoji.className = 'counting-vote';
                emoji.innerHTML = '';
                document.body.appendChild(emoji);
                const rect = card.getBoundingClientRect();
                emoji.style.left = (window.innerWidth/2) + 'px';
                emoji.style.top = (window.innerHeight - 50) + 'px';
                setTimeout(() => {
                    emoji.style.transform = `translate(${rect.left - window.innerWidth/2 + rect.width/2}px, ${rect.top - window.innerHeight + 50}px) scale(1.5)`;
                    emoji.style.opacity = 0;
                }, 50);
                setTimeout(() => emoji.remove(), 800);
            }
            document.getElementById('counting-status').textContent = `CERTIFYING VOTE ${i+1} OF ${votes.length}`;
            i++;
        }, 400);
    }

    // --- TEMPLATE & HELP ---
    document.getElementById('download-sample-btn').onclick = () => {
        const data = [{name: 'Arun Kumar', class: '10-A', gender: 'Male'}, {name: 'Sneha S', class: '10-A', gender: 'Female'}];
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Voters");
        XLSX.writeFile(wb, "election_template.xlsx");
    };

    instructionsButton.onclick = () => {
        showModal({
            title: 'OPERATIONAL PROTOCOL',
            body: `
                <div class="space-y-4 text-sm font-medium">
                    <p><strong class="text-blue-500">I. Initialization:</strong> Import your population using the Excel template. Name and Class are required fields.</p>
                    <p><strong class="text-blue-500">II. Security:</strong> Create a session and set a PIN. This PIN is required to unlock the voting booth and finalize tallies.</p>
                    <p><strong class="text-blue-500">III. Imaging:</strong> Use the nomination tool to upload portraits. The system forces a materialistic square crop for UI consistency.</p>
                    <p><strong class="text-blue-500">IV. Voting:</strong> TAB key advances the queue. ESC key requires the PIN to close the booth session.</p>
                    <p><strong class="text-blue-500">V. Integrity:</strong> Data is purely local. Clearing history wipes the DB. <strong class="text-white underline">Export backups (.json) regularly.</strong></p>
                </div>
            `,
            cancelText: 'ACKNOWLEDGED'
        });
    };

    // --- SYSTEM INIT ---
    const initSystem = async () => {
        try {
            await db.init();
            const res = await fetch('schools.json');
            if(!res.ok) throw new Error();
            schoolsData = await res.json();
            loadState();
            if(!localStorage.getItem('sysInit')) {
                showModal({ title: 'CRITICAL DATA WARNING', body: 'This suite is 100% OFFLINE. All intelligence is stored only in this browser. Clearing history or cache will result in <strong class="text-white">TOTAL DATA LOSS</strong>. Export your vault (.json) daily.', cancelText: 'I UNDERSTAND', onCancel: () => localStorage.setItem('sysInit', '1') });
            }
        } catch (e) {
            document.body.innerHTML = `<div class="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-12 text-center">
                <div class="bg-rose-500/10 p-6 rounded-full text-rose-500 mb-8"><svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                <h1 class="text-4xl font-black text-white mb-4">LOCAL ACCESS DENIED</h1>
                <p class="text-slate-400 max-w-sm mb-12">CORS policy blocks file access to <strong>schools.json</strong>. You must serve this folder via HTTP.</p>
                <div class="bg-slate-900 border border-slate-800 p-8 rounded-[2rem] font-mono text-left w-full max-w-md text-emerald-400">
                    <p class="text-slate-600 text-xs mb-4 uppercase font-black"># Execute in terminal:</p>
                    python -m http.server 8000
                </div>
            </div>`;
        }
    };

    initSystem();
    showView('homepage-view');

    // Remaining Logic (PDF generation, result finalization, etc.) included in the full logic chain.
    // [Note: Functions like finalizeResults, generateCandidateListReport are implemented similarly to the previous logic but updated for this UI.]
});

// Finalize Results logic
function finalizeResults(cls) {
    const el = appData.elections.find(e => e.id === appData.activeElectionId);
    const votes = el.votes[cls] || [];
    const tallies = {};
    el.candidates.filter(c => c.class === cls).forEach(c => tallies[c.id] = 0);
    if(el.includeNota) tallies['NOTA'] = 0;
    
    votes.forEach(v => { if(tallies[v.cid] !== undefined) tallies[v.cid]++; });
    
    const sorted = Object.entries(tallies)
        .filter(([id]) => id !== 'NOTA')
        .sort((a,b) => b[1] - a[1]);
        
    const winnerId = sorted[0]?.[0];
    el.classStatus[cls] = { status: 'counted', winnerId };
    
    // Show Result Modal
    let body = `<div class="space-y-6 text-center">`;
    if(winnerId) {
        const winner = el.candidates.find(c => c.id === winnerId);
        body += `<h4 class="text-4xl font-black text-emerald-400">${winner.name} Elected</h4>`;
    }
    body += `<div class="bg-slate-950 p-6 rounded-3xl border border-slate-800 text-left space-y-3">`;
    Object.entries(tallies).forEach(([id, count]) => {
        const name = id === 'NOTA' ? 'NOTA' : el.candidates.find(x => x.id === id).name;
        body += `<div class="flex justify-between font-bold"><span>${name}</span><span class="text-blue-400">${count}</span></div>`;
    });
    body += `</div></div>`;
    
    localStorage.setItem('electionAppData', JSON.stringify(appData));
    showModal({ title: `ELECTION CERTIFIED: ${cls}`, body, cancelText: 'CLOSE' });
    window.location.reload();
}

async function generateCandidateListReport() {
    const election = appData.elections.find(e => e.id === appData.activeElectionId);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(22);
    doc.text(`BALLOT REGISTRY: ${appData.school.name}`, 14, 25);
    doc.setFontSize(12);
    doc.text(`SESSION: ${election.name}`, 14, 35);
    let y = 50;

    const grouped = election.candidates.reduce((acc, c) => { if(!acc[c.class]) acc[c.class] = []; acc[c.class].push(c); return acc; }, {});

    for (const cls of Object.keys(grouped).sort()) {
        if(y > 250) { doc.addPage(); y = 20; }
        doc.setFontSize(16);
        doc.setTextColor(59, 130, 246);
        doc.text(`CLASS: ${cls}`, 14, y);
        y += 8;

        const tableData = [];
        for(const c of grouped[cls]) {
            let img = '';
            if(c.hasImage) {
                const b = await db.getImage(c.id);
                if(b) {
                    const r = new FileReader();
                    img = await new Promise(resolve => { r.onload = e => resolve(e.target.result); r.readAsDataURL(b); });
                }
            } else {
                // Simplified canvas to dataURL for default icons
                img = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='; 
            }
            tableData.push([{ content: '', image: img }, c.name, c.gender]);
        }

        doc.autoTable({
            head: [['PORTRAIT', 'FULL NAME', 'GENDER']],
            body: tableData,
            startY: y,
            theme: 'grid',
            styles: { minCellHeight: 25, verticalAlign: 'middle' },
            columnStyles: { 0: { cellWidth: 30 } },
            didDrawCell: (data) => {
                if (data.column.index === 0 && data.cell.section === 'body' && data.cell.raw.image) {
                    doc.addImage(data.cell.raw.image, 'JPEG', data.cell.x + 5, data.cell.y + 2.5, 20, 20);
                }
            }
        });
        y = doc.lastAutoTable.finalY + 15;
    }
    doc.save(`ballot_${election.name.replace(/\s+/g, '_')}.pdf`);
}
</script>
</body>
</html>
