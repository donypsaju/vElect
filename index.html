<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vElect - Pro Election Suite</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --slate-950: #020617;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            scrollbar-gutter: stable;
            background-color: var(--slate-950);
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .view { display: none; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .active-view { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .modal-backdrop { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(12px); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 1000; 
        }
        .modal-content { 
            background-color: var(--slate-900); 
            color: #f8fafc; 
            padding: 2.5rem; 
            border-radius: 2rem; 
            border: 1px solid #1e293b; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); 
            width: 95%; 
            max-width: 680px; 
            display: flex; 
            flex-direction: column; 
            max-height: 90vh; 
        }
        .modal-body { overflow-y: auto; padding-right: 0.5rem; }
        
        .input-dark { 
            background-color: #020617; 
            border: 1px solid #334155; 
            color: #f1f5f9; 
            transition: all 0.2s ease;
        }
        .input-dark:focus { 
            border-color: #3b82f6; 
            outline: none; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); 
        }

        .counting-vote { 
            animation: flyToCandidate 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
            position: absolute; 
            font-size: 3rem; 
            z-index: 100; 
            pointer-events: none; 
        }
        @keyframes flyToCandidate { 
            0% { transform: scale(1) translateY(0); opacity: 1; } 
            100% { transform: scale(2.5) translateY(-200px); opacity: 0; } 
        }

        #candidate-cards { 
            display: grid; 
            gap: 1.5rem; 
            place-items: center; 
            height: calc(100vh - 250px); 
            padding: 1rem; 
            overflow: hidden;
        }
        
        .cropper-container { 
            max-height: 400px; 
            width: 100%; 
            background: #000; 
            overflow: hidden; 
            border-radius: 1rem; 
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="app-container" class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <header class="bg-slate-900/60 backdrop-blur-xl border border-slate-800 shadow-2xl rounded-[2rem] p-5 mb-10 flex justify-between items-center sticky top-6 z-50">
            <div class="flex items-center space-x-4 cursor-pointer group" onclick="location.reload()">
                <div class="bg-blue-600 p-2.5 rounded-xl shadow-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h1 id="header-title" class="text-xl font-black tracking-tighter text-white uppercase">vElect Portal</h1>
            </div>
            <div id="header-buttons" class="flex items-center space-x-3">
                <button id="instructions-btn" class="hidden bg-slate-800 hover:bg-slate-700 text-slate-200 text-xs font-black py-2.5 px-6 rounded-xl border border-slate-700 transition-all uppercase tracking-widest">Guide</button>
                <button id="logout-button" class="hidden bg-rose-600/10 hover:bg-rose-600 text-rose-500 hover:text-white text-xs font-black py-2.5 px-6 rounded-xl border border-rose-500/20 transition-all">Logout</button>
            </div>
        </header>

        <main id="main-content">
            <!-- 0. Homepage -->
            <div id="homepage-view" class="view active-view">
                <div class="max-w-4xl mx-auto text-center py-20">
                    <h1 class="text-7xl font-black text-white mb-6 leading-none tracking-tighter">Digital Voting. <br><span class="text-blue-500">Secured Offline.</span></h1>
                    <p class="text-xl text-slate-400 leading-relaxed mb-12 max-w-2xl mx-auto">Conduct school elections with materialistic elegance and absolute data privacy.</p>
                    <button id="goto-login-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-5 px-16 rounded-[2rem] text-xl shadow-2xl shadow-blue-900/40 transition transform hover:-translate-y-1 active:scale-95 uppercase tracking-widest">Get Started</button>
                </div>

                <div class="grid md:grid-cols-3 gap-8 mt-12">
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800">
                        <div class="text-blue-500 mb-6"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                        <h3 class="text-xl font-black mb-2 text-white">Privacy First</h3>
                        <p class="text-slate-400 text-sm">Every vote and portrait stays inside your browser's private database. No cloud, no leaks.</p>
                    </div>
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800">
                        <div class="text-indigo-500 mb-6"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                        <h3 class="text-xl font-black mb-2 text-white">Audit Trail</h3>
                        <p class="text-slate-400 text-sm">Download signed PDF results with analytics and candidate photos automatically generated.</p>
                    </div>
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800">
                        <div class="text-emerald-500 mb-6"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-1.428A9.99 9.99 0 0012 21a9.99 9.99 0 008.213-4.286M9 11V9a3 3 0 016 0v2m-6 5h6"></path></svg></div>
                        <h3 class="text-xl font-black mb-2 text-white">Smart Booth</h3>
                        <p class="text-slate-400 text-sm">Kiosk-mode voting screen adapts to any candidate count, ensuring no scrolling for voters.</p>
                    </div>
                </div>
            </div>

            <!-- 1. Login -->
            <div id="login-view" class="view max-w-md mx-auto bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl">
                <h2 class="text-4xl font-black text-center mb-10 tracking-tight text-white">Admin Login</h2>
                <div class="space-y-6">
                    <input id="admin-user" type="text" placeholder="Username" class="w-full p-4 rounded-2xl input-dark text-lg font-bold" value="admin">
                    <input id="admin-pass" type="password" placeholder="Password" class="w-full p-4 rounded-2xl input-dark text-lg font-bold" value="admin123">
                    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all">AUTHORIZE SESSION</button>
                </div>
            </div>

            <!-- 2. Institution Link -->
            <div id="school-setup-view" class="view max-w-lg mx-auto bg-slate-900 p-12 rounded-[3rem] border border-slate-800 shadow-2xl">
                <h2 class="text-4xl font-black mb-4 tracking-tight text-white text-center">Institution Setup</h2>
                <p class="mb-10 text-slate-400 text-center font-medium leading-relaxed">Map your institution to the local database.</p>
                <div class="space-y-6">
                    <div>
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Institution Code (Optional)</label>
                        <input id="school-code-input" type="text" placeholder="e.g. 42003" class="w-full p-4 rounded-2xl input-dark font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2 ml-1">Institution Name <span class="text-blue-500">*</span></label>
                        <input id="school-name-input" type="text" placeholder="e.g. Govt. Model School" class="w-full p-4 rounded-2xl input-dark font-bold">
                    </div>
                </div>
                <button id="confirm-school-btn" class="w-full mt-12 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all">INITIALIZE SUITE</button>
                <button id="report-missing-school-btn" class="mt-8 w-full text-sm text-slate-500 hover:text-blue-400 transition font-bold underline decoration-slate-700">Missing from lookup?</button>
            </div>

            <!-- 3. Admin Dashboard -->
            <div id="admin-dashboard-view" class="view">
                <div class="flex items-end justify-between mb-12 border-b border-slate-800 pb-8">
                    <div>
                        <span class="text-[10px] font-black text-blue-500 uppercase tracking-[0.3em]">Operational Unit</span>
                        <h2 class="text-5xl font-black text-white tracking-tighter mt-2" id="dashboard-school-name"></h2>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Voters -->
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-xl flex flex-col">
                        <h3 class="text-xl font-black mb-8 flex items-center text-white"><span class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center mr-4 text-sm font-black text-white">1</span> POPULATION</h3>
                        <p class="text-slate-400 text-sm mb-10 leading-relaxed flex-grow font-medium">Load your voter registry via Excel integration.</p>
                        <div class="space-y-4">
                            <input type="file" id="student-file-input" accept=".xlsx, .xls" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-full file:border-0 file:text-xs file:font-black file:bg-blue-600/10 file:text-blue-400 hover:file:bg-blue-600/20 cursor-pointer"/>
                            <button id="download-sample-btn" class="w-full bg-slate-950 hover:bg-slate-800 text-slate-300 font-black py-4 rounded-2xl border border-slate-800 transition shadow-inner">GET TEMPLATE</button>
                        </div>
                        <div id="student-data-status" class="mt-6 text-emerald-400 font-black text-[10px] uppercase tracking-widest text-center"></div>
                    </div>

                    <!-- Setup -->
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-xl">
                        <h3 id="election-form-title" class="text-xl font-black mb-8 flex items-center text-white"><span class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center mr-4 text-sm font-black text-white">2</span> SESSION</h3>
                        <div class="space-y-4">
                            <input id="election-name" type="text" placeholder="Election Title" class="w-full p-4 rounded-2xl input-dark font-bold">
                            <input id="election-password" type="password" placeholder="Booth Security PIN" class="w-full p-4 rounded-2xl input-dark font-bold">
                            <label class="flex items-center space-x-3 cursor-pointer bg-slate-950/80 p-4 rounded-2xl border border-slate-800 transition hover:border-slate-700">
                                <input id="include-nota" type="checkbox" class="w-6 h-6 rounded-lg border-slate-700 bg-slate-950 text-blue-600 focus:ring-blue-600">
                                <span class="text-sm text-slate-400 font-bold">Ballot NOTA Option</span>
                            </label>
                            <div id="election-form-buttons">
                                <button id="create-election-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-xl transition-all">INITIALIZE SESSION</button>
                            </div>
                        </div>
                    </div>

                    <!-- Vault -->
                    <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800 shadow-xl flex flex-col">
                        <h3 class="text-xl font-black mb-8 text-white uppercase tracking-tighter">Existing Sessions</h3>
                        <div id="election-list" class="space-y-4 overflow-y-auto max-h-[350px] pr-2"></div>
                    </div>
                </div>

                <!-- Active Election Management -->
                <div id="active-election-section" class="mt-16 space-y-12 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800">
                            <h3 class="text-2xl font-black mb-10 flex items-center text-white"><span class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center mr-4 text-sm font-black text-white">3</span> NOMINATION</h3>
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <select id="candidate-class-select" class="w-full p-4 rounded-2xl input-dark font-bold"></select>
                                    <select id="candidate-name-select" class="w-full p-4 rounded-2xl input-dark font-bold"></select>
                                </div>
                                <input id="candidate-gender" type="text" placeholder="Gender Profile" class="w-full p-4 rounded-2xl input-dark opacity-40 font-bold" readonly>
                                <div class="bg-slate-950 p-6 rounded-2xl border border-slate-800">
                                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4">Ballot Portrait</label>
                                    <input type="file" id="candidate-image-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2.5 file:px-6 file:rounded-full file:border-0 file:text-xs file:font-black file:bg-blue-600/10 file:text-blue-400 hover:file:bg-blue-600/20 cursor-pointer"/>
                                </div>
                                <button id="add-candidate-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase tracking-widest">Register Candidate</button>
                            </div>
                        </div>

                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800">
                            <h3 class="text-2xl font-black mb-10 text-white uppercase tracking-tighter">Live Ballot Data</h3>
                            <div id="candidate-list" class="space-y-6 max-h-[500px] overflow-y-auto pr-3"></div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-600/10 to-indigo-600/10 p-10 rounded-[3.5rem] border border-blue-500/20 shadow-2xl">
                        <h3 class="text-2xl font-black mb-10 flex items-center text-white"><span class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center mr-4 text-sm font-black text-white">4</span> OPERATIONS</h3>
                        <div class="grid sm:grid-cols-3 gap-8">
                            <button id="goto-voting-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-8 rounded-3xl transition shadow-2xl text-xl uppercase tracking-widest">Start Voting</button>
                            <button id="goto-counting-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-black py-8 rounded-3xl transition shadow-2xl text-xl uppercase tracking-widest">Begin Counting</button>
                            <button id="goto-reports-btn" class="bg-slate-800 hover:bg-slate-700 text-white font-black py-8 rounded-3xl border border-slate-700 transition text-xl uppercase tracking-widest">Audit Reports</button>
                        </div>
                    </div>
                </div>

                <!-- Backup Utility -->
                <div class="mt-16 bg-slate-900/20 p-10 rounded-[3rem] border-2 border-dashed border-slate-800 flex flex-col sm:flex-row items-center justify-center gap-6">
                    <button id="export-data-btn" class="bg-slate-900 hover:bg-slate-800 text-slate-300 py-3 px-10 rounded-2xl border border-slate-800 transition font-black">EXPORT VAULT (.json)</button>
                    <label for="import-data-input" class="bg-slate-900 hover:bg-slate-800 text-slate-400 py-3 px-10 rounded-2xl border border-slate-800 transition font-black cursor-pointer">IMPORT RECOVERY FILE</label>
                    <input type="file" id="import-data-input" class="hidden" accept=".json">
                </div>
            </div>
            
            <!-- Voting Hub -->
            <div id="voting-class-selection-view" class="view p-10">
                <div class="flex items-center justify-between mb-10">
                    <h2 class="text-4xl font-black text-white">Election Hub</h2>
                    <button onclick="showView('admin-dashboard-view')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 px-8 rounded-2xl border border-slate-700 transition font-black uppercase">Exit</button>
                </div>
                <div id="voter-selection-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 text-center"></div>
            </div>

            <!-- Booth View -->
            <div id="voting-screen-view" class="view h-screen fixed inset-0 z-[100] bg-slate-950" oncontextmenu="return false;">
                <div class="flex flex-col h-full">
                    <div class="text-center py-10 bg-slate-900/50 border-b border-slate-800">
                        <h2 id="booth-title" class="text-6xl font-black text-blue-400 mb-4 tracking-tighter uppercase"></h2>
                        <p id="voter-counter" class="text-2xl text-slate-500 font-black tracking-widest uppercase"></p>
                    </div>
                    <div id="candidate-cards" class="flex-grow p-10 overflow-hidden"></div>
                    <div class="py-6 text-center text-slate-700 font-black uppercase text-[10px] tracking-[1em]">vElect Secure Booth Terminal</div>
                </div>
                <!-- Success Flash -->
                <div id="vote-cast-overlay" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-md flex flex-col justify-center items-center text-white z-50">
                    <div class="bg-emerald-500 rounded-full p-6 mb-8 shadow-2xl shadow-emerald-900/40">
                        <svg class="w-20 h-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <h2 class="text-6xl font-black mb-4 uppercase">Vote Recorded</h2>
                    <p class="text-2xl text-slate-400 font-bold uppercase">Please leave the booth. System advancing...</p>
                </div>
            </div>

            <!-- Tally Views -->
            <div id="counting-class-selection-view" class="view p-10">
                <div class="flex items-center justify-between mb-10">
                    <h2 class="text-4xl font-black text-white">Tally Hub</h2>
                    <button onclick="showView('admin-dashboard-view')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 px-8 rounded-2xl border border-slate-700 transition font-black uppercase">Exit</button>
                </div>
                <div id="counting-selection-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
            </div>

            <div id="counting-screen-view" class="view h-screen fixed inset-0 z-[100] bg-slate-950 flex flex-col">
                <div class="text-center py-10">
                    <h2 id="counting-header" class="text-6xl font-black text-indigo-400 mb-2 tracking-tighter uppercase"></h2>
                    <p id="counting-status" class="text-2xl text-slate-500 font-black uppercase"></p>
                    <button id="begin-counting-btn" class="mt-8 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 px-16 rounded-2xl shadow-2xl transition transform hover:scale-105 uppercase tracking-widest">Commence Audit</button>
                </div>
                <div id="counting-candidate-list" class="flex-grow p-10 overflow-hidden"></div>
            </div>

            <!-- Intelligence View -->
            <div id="reports-view" class="view p-10">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-12">
                        <h2 class="text-4xl font-black text-white">Analytics Center</h2>
                        <button onclick="showView('admin-dashboard-view')" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 px-8 rounded-2xl border border-slate-700 transition font-black">EXIT</button>
                    </div>
                    <div class="bg-slate-900 p-12 rounded-[3.5rem] border border-slate-800 shadow-2xl text-center">
                        <p class="text-slate-400 font-bold mb-10 uppercase tracking-widest">Signed Election Documentation</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <button id="report-candidates-btn" class="bg-slate-800 hover:bg-slate-700 text-white font-black py-8 rounded-3xl border border-slate-700 transition">BALLOT LIST</button>
                            <button id="report-winners-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-8 rounded-3xl transition shadow-xl">WINNERS LIST</button>
                            <button id="report-detailed-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-black py-8 rounded-3xl transition shadow-xl">FULL AUDIT</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- UI Overlay: Crop Modal -->
    <div id="crop-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-xl">
            <h3 class="text-2xl font-black mb-6 uppercase tracking-tight">Voter Identity Portrait</h3>
            <div class="cropper-container"><img id="crop-image" src=""></div>
            <div class="mt-10 flex justify-between items-center">
                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Adjust to fit square frame</p>
                <div class="space-x-4">
                    <button id="crop-cancel" class="bg-slate-800 px-8 py-3 rounded-xl font-bold border border-slate-700 transition hover:bg-slate-700">Cancel</button>
                    <button id="crop-confirm" class="bg-blue-600 px-8 py-3 rounded-xl font-black shadow-xl transition hover:bg-blue-500">Apply Crop</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Overlay: Dialog -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-black mb-4 uppercase"></h3>
            <div id="modal-body" class="modal-body text-slate-300 font-medium"></div>
            <div id="modal-footer" class="mt-10 flex justify-end space-x-4 pt-6 border-t border-slate-800/50">
                <button id="modal-cancel-btn" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-xl transition border border-slate-700 uppercase">Cancel</button>
                <button id="modal-confirm-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-3 px-8 rounded-xl shadow-lg transition uppercase">Confirm</button>
            </div>
        </div>
    </div>

    <!-- UI Overlay: Progress -->
    <div id="progress-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-xs text-center">
            <h3 id="progress-title" class="text-xl font-black mb-8 uppercase tracking-widest">Processing</h3>
            <div class="w-full bg-slate-950 rounded-full h-2 border border-slate-800 mb-6 overflow-hidden">
                <div id="progress-bar" class="bg-blue-500 h-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-[10px] text-slate-500 font-black uppercase tracking-widest"></p>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SYSTEM STATE ---
    let appData = { school: null, students: [], classes: {}, elections: [], activeElectionId: null, currentVotingClass: null, currentVoterIndex: 0, loggedIn: false };
    let schoolsData = [];
    const femaleIcon = 'female.png';
    const maleIcon = 'male.png';

    // --- DOM CACHE ---
    const views = document.querySelectorAll('.view');
    const headerTitle = document.getElementById('header-title');
    const headerButtons = document.getElementById('header-buttons');
    const logoutButton = document.getElementById('logout-button');
    const instructionsButton = document.getElementById('instructions-btn');

    // --- STORAGE ENGINE (IndexedDB) ---
    const db = {
        instance: null,
        async init() {
            return new Promise((res, rej) => {
                const req = indexedDB.open('ElectionDB', 4);
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('candidate_images')) {
                        d.createObjectStore('candidate_images', { keyPath: 'id' });
                    }
                };
                req.onsuccess = (e) => { this.instance = e.target.result; res(); };
                req.onerror = (e) => rej(e.target.errorCode);
            });
        },
        async addImage(id, blob) {
            const tx = this.instance.transaction(['candidate_images'], 'readwrite');
            return new Promise((res, rej) => {
                const req = tx.objectStore('candidate_images').put({ id, image: blob });
                req.onsuccess = () => res();
                req.onerror = () => rej();
            });
        },
        async getImage(id) {
            return new Promise(res => {
                const tx = this.instance.transaction(['candidate_images'], 'readonly');
                const req = tx.objectStore('candidate_images').get(id);
                req.onsuccess = () => res(req.result?.image);
                req.onerror = () => res(null);
            });
        },
        async deleteImage(id) {
            this.instance.transaction(['candidate_images'], 'readwrite').objectStore('candidate_images').delete(id);
        }
    };

    // --- IMAGE HELPER ---
    const convertToBase64 = (blobOrUrl) => {
        return new Promise((resolve) => {
            if (blobOrUrl instanceof Blob) {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blobOrUrl);
            } else {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    canvas.getContext('2d').drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = () => resolve(null);
                img.src = blobOrUrl;
            }
        });
    };

    // --- UI LOGIC ---
    const showView = (id) => {
        views.forEach(v => v.classList.remove('active-view'));
        document.getElementById(id).classList.add('active-view');
        
        const isAuth = appData.loggedIn && !['homepage-view', 'login-view'].includes(id);
        const hideChrome = ['voting-screen-view', 'counting-screen-view'].includes(id);
        
        logoutButton.classList.toggle('hidden', !isAuth);
        instructionsButton.classList.toggle('hidden', !isAuth);
        headerButtons.classList.toggle('hidden', hideChrome);
        headerTitle.textContent = appData.school ? appData.school.name : 'vElect';
    };

    const saveState = () => {
        const copy = { ...appData };
        copy.elections = appData.elections.map(el => {
            const elCopy = { ...el };
            elCopy.candidates = el.candidates.map(c => { const { image, ...rest } = c; return rest; });
            return elCopy;
        });
        localStorage.setItem('electionAppData', JSON.stringify(copy));
    };

    const loadState = () => {
        const saved = localStorage.getItem('electionAppData');
        if (saved) {
            appData = JSON.parse(saved);
            if (!Array.isArray(appData.elections)) appData.elections = [];
            if (appData.loggedIn && appData.school) { showView('admin-dashboard-view'); renderAdminDashboard(); }
            else if (appData.loggedIn) showView('school-setup-view');
            else showView('homepage-view');
        }
    };

    const showModal = (cfg) => {
        const { title, body, onConfirm, confirmText = 'Confirm', onCancel, cancelText = 'Cancel', requiresInput = false } = cfg;
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = body;
        if (requiresInput) document.getElementById('modal-body').innerHTML += `<input type="password" id="modal-password-input" class="w-full p-4 mt-4 rounded-2xl input-dark text-center font-black text-4xl tracking-[0.5em]">`;
        const cBtn = document.getElementById('modal-confirm-btn');
        const xBtn = document.getElementById('modal-cancel-btn');
        cBtn.textContent = confirmText; xBtn.textContent = cancelText;
        if (onConfirm) {
            cBtn.classList.remove('hidden');
            cBtn.onclick = () => { onConfirm(document.getElementById('modal-password-input')?.value); document.getElementById('modal').classList.add('hidden'); };
        } else cBtn.classList.add('hidden');
        xBtn.onclick = () => { if (onCancel) onCancel(); document.getElementById('modal').classList.add('hidden'); };
        document.getElementById('modal').classList.remove('hidden');
    };

    const getActiveElection = () => appData.elections.find(e => e.id === appData.activeElectionId);

    // --- CROPPER CONTROLLER ---
    let cropperInstance = null;
    document.getElementById('candidate-image-input').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById('crop-image').src = ev.target.result;
            document.getElementById('crop-modal').classList.remove('hidden');
            if (cropperInstance) cropperInstance.destroy();
            cropperInstance = new Cropper(document.getElementById('crop-image'), { 
                aspectRatio: 1, viewMode: 1, autoCropArea: 1, dragMode: 'move', background: false 
            });
        };
        reader.readAsDataURL(file);
    };

    document.getElementById('crop-confirm').onclick = () => {
        const election = getActiveElection();
        if(!election) return;
        cropperInstance.getCroppedCanvas({ width: 512, height: 512 }).toBlob(async (blob) => {
            const id = Date.now().toString();
            const n = document.getElementById('candidate-name-select').value;
            const c = document.getElementById('candidate-class-select').value;
            const g = document.getElementById('candidate-gender').value;
            await db.addImage(id, blob);
            election.candidates.push({ id, name: n, class: c, gender: g, hasImage: true });
            saveState(); renderCandidateList();
            document.getElementById('crop-modal').classList.add('hidden');
            document.getElementById('candidate-image-input').value = null;
        }, 'image/jpeg', 0.9);
    };

    document.getElementById('crop-cancel').onclick = () => {
        document.getElementById('crop-modal').classList.add('hidden');
        document.getElementById('candidate-image-input').value = null;
    };

    // --- DASHBOARD HANDLERS ---
    document.getElementById('goto-login-btn').onclick = () => showView('login-view');
    document.getElementById('login-btn').onclick = () => {
        const u = document.getElementById('admin-user').value;
        const p = document.getElementById('admin-pass').value;
        if(u === 'admin' && p === 'admin123') {
            appData.loggedIn = true;
            if(appData.school) { showView('admin-dashboard-view'); renderAdminDashboard(); }
            else showView('school-setup-view');
            saveState();
        } else showModal({ title: 'Access Denied', body: 'Invalid administrator credentials.', cancelText: 'Retry' });
    };

    document.getElementById('confirm-school-btn').onclick = () => {
        const n = document.getElementById('school-name-input').value.trim();
        const c = document.getElementById('school-code-input').value.trim();
        if(n) { appData.school = { code: c || 'N/A', name: n }; saveState(); showView('admin-dashboard-view'); renderAdminDashboard(); }
        else showModal({ title: 'Validation Error', body: 'Institution name is compulsory.', cancelText: 'OK' });
    };

    document.getElementById('create-election-btn').onclick = () => {
        const n = document.getElementById('election-name').value.trim();
        const p = document.getElementById('election-password').value.trim();
        const i = document.getElementById('include-nota').checked;
        if(n && p) {
            appData.elections.push({ id: Date.now().toString(), name: n, password: p, includeNota: i, candidates: [], votes: {}, classStatus: {} });
            saveState(); renderAdminDashboard();
            document.getElementById('election-name').value = ''; document.getElementById('election-password').value = '';
        } else showModal({ title: 'Validation Error', body: 'Name and PIN are required.', cancelText: 'OK' });
    };

    document.getElementById('download-sample-btn').onclick = () => {
        const ws = XLSX.utils.json_to_sheet([{name: 'John Doe', class: '10-A', gender: 'Male'}]);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Voters");
        XLSX.writeFile(wb, "vElect_Template.xlsx");
    };

    document.getElementById('add-candidate-btn').onclick = () => {
        const election = getActiveElection();
        const n = document.getElementById('candidate-name-select').value;
        const c = document.getElementById('candidate-class-select').value;
        const g = document.getElementById('candidate-gender').value;
        if(!n || !c) return showModal({ title: 'Error', body: 'Selection incomplete.', cancelText: 'OK' });
        
        if (document.getElementById('candidate-image-input').files.length === 0) {
            const id = Date.now().toString();
            election.candidates.push({ id, name: n, class: c, gender: g, hasImage: false });
            saveState(); renderCandidateList();
            showModal({ title: 'Registered', body: `${n} added without photo.`, cancelText: 'OK' });
        }
    };

    document.getElementById('logout-button').onclick = () => {
        appData.loggedIn = false; saveState(); window.location.reload();
    };

    // --- VOTING LOGIC ---
    document.getElementById('goto-voting-btn').onclick = () => {
        const el = getActiveElection();
        const grid = document.getElementById('voter-selection-grid');
        grid.innerHTML = Object.keys(appData.classes).sort().map(cls => {
            const isDone = el.classStatus[cls]?.status === 'voted' || el.classStatus[cls]?.status === 'counted';
            return `<button class="p-8 rounded-[2rem] font-black text-xl border-2 transition-all transform hover:scale-105 ${isDone ? 'bg-slate-900 border-slate-800 text-slate-600' : 'bg-blue-600 border-blue-500 text-white shadow-xl shadow-blue-900/30'}" onclick="initBooth('${cls}')">${cls}${isDone ? '<br><span class="text-[10px] opacity-40">CLOSED</span>' : ''}</button>`;
        }).join('');
        showView('voting-class-selection-view');
    };

    window.initBooth = (cls) => {
        const el = getActiveElection();
        if(el.classStatus[cls]?.status === 'voted') return showModal({ title: 'Access Denied', body: 'Booth session for this class is finalized.', cancelText: 'OK' });
        showModal({ title: `Booth Access: ${cls}`, body: 'Enter PIN to authorize terminal.', requiresInput: true, onConfirm: (pin) => {
            if(pin === el.password) {
                appData.currentVotingClass = cls; appData.currentVoterIndex = 0;
                if(!el.votes[cls]) el.votes[cls] = [];
                renderVotingScreen(); showView('voting-screen-view'); enterFullScreen(document.documentElement);
            } else showModal({ title: 'Invalid PIN', body: 'Unauthorized entry.', cancelText: 'Retry' });
        }});
    };

    async function renderVotingScreen() {
        const el = getActiveElection();
        const cls = appData.currentVotingClass;
        const voters = appData.classes[cls];
        const candidates = el.candidates.filter(c => c.class === cls);
        const totalCards = candidates.length + (el.includeNota ? 1 : 0);
        
        let cols = totalCards > 9 ? 'grid-cols-5' : totalCards > 4 ? 'grid-cols-3' : 'grid-cols-2';
        document.getElementById('booth-title').textContent = `${cls} SESSION`;
        document.getElementById('voter-counter').textContent = `Sequence: ${appData.currentVoterIndex + 1} / ${voters.length}`;
        
        const cardCont = document.getElementById('candidate-cards');
        cardCont.className = `grid ${cols} gap-6 max-w-6xl mx-auto items-center`;
        
        let html = candidates.map(c => `
            <div class="bg-slate-900 border-4 border-slate-800 p-8 rounded-[3rem] text-center cursor-pointer transition transform hover:scale-105 hover:border-blue-500 group" onclick="castVote('${c.id}')">
                <img id="ballot-img-${c.id}" src="" class="w-32 h-32 md:w-48 md:h-48 rounded-full mx-auto mb-6 object-cover border-4 border-slate-800 bg-slate-800">
                <h3 class="text-3xl font-black text-white group-hover:text-blue-400 truncate">${c.name}</h3>
            </div>
        `).join('');
        
        if (el.includeNota) {
            html += `<div class="bg-slate-900 border-4 border-slate-800 p-8 rounded-[3rem] text-center cursor-pointer transition transform hover:scale-105 hover:border-slate-500 group" onclick="castVote('NOTA')">
                <div class="w-32 h-32 md:w-48 md:h-48 rounded-full mx-auto mb-6 bg-slate-800 flex items-center justify-center border-4 border-slate-700 text-slate-600"><svg class="w-24 h-24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg></div>
                <h3 class="text-3xl font-black text-slate-500 group-hover:text-slate-400">NOTA</h3>
            </div>`;
        }
        cardCont.innerHTML = html;

        for(const c of candidates) {
            const img = document.getElementById(`ballot-img-${c.id}`);
            if(c.hasImage) {
                const b = await db.getImage(c.id);
                if(b) img.src = URL.createObjectURL(b);
            } else img.src = c.gender.toLowerCase().startsWith('f') ? femaleIcon : maleIcon;
        }
    }

    window.castVote = (cid) => {
        const el = getActiveElection();
        new Tone.Synth().toDestination().triggerAttackRelease("C4", "8n");
        el.votes[appData.currentVotingClass].push({ voter: appData.currentVoterIndex, cid });
        saveState();
        document.getElementById('vote-cast-overlay').classList.remove('hidden');
    };

    // --- COUNTING LOGIC ---
    document.getElementById('goto-counting-btn').onclick = () => {
        const el = getActiveElection();
        const grid = document.getElementById('counting-selection-grid');
        grid.innerHTML = Object.keys(appData.classes).sort().map(cls => {
            const status = el.classStatus[cls]?.status;
            const active = status === 'voted';
            const done = status === 'counted';
            return `<button class="p-8 rounded-[2rem] font-black text-xl border-2 transition-all transform hover:scale-105 ${active ? 'bg-indigo-600 border-indigo-500 text-white shadow-xl shadow-indigo-900/30' : 'bg-slate-900 border-slate-800 text-slate-600'}" onclick="initCount('${cls}')">${cls}${done ? '<br><span class="text-[10px] opacity-40 uppercase">CERTIFIED</span>' : ''}</button>`;
        }).join('');
        showView('counting-class-selection-view');
    };

    window.initCount = (cls) => {
        const el = getActiveElection();
        if(el.classStatus[cls]?.status !== 'voted') return showModal({ title: 'Unavailable', body: 'Voting must be closed for this class first.', cancelText: 'OK' });
        
        document.getElementById('counting-header').textContent = `TALLY: ${cls}`;
        document.getElementById('counting-status').textContent = 'READY FOR AUDIT';
        
        const candidates = el.candidates.filter(c => c.class === cls);
        const totalItems = candidates.length + (el.includeNota ? 1 : 0);
        let cols = totalItems > 9 ? 'grid-cols-5' : totalItems > 4 ? 'grid-cols-3' : 'grid-cols-2';
        
        const list = document.getElementById('counting-candidate-list');
        list.className = `grid ${cols} gap-6 max-w-7xl mx-auto p-10`;
        list.innerHTML = candidates.map(c => `
            <div class="candidate-result-item flex flex-col items-center bg-slate-900 p-8 rounded-[2.5rem] border border-slate-800" data-cid="${c.id}" data-votes="0">
                <img id="count-img-${c.id}" src="" class="w-24 h-24 rounded-full mb-6 object-cover border-4 border-slate-800">
                <p class="font-black text-white text-lg mb-4 text-center truncate w-full">${c.name}</p>
                <div class="w-full bg-slate-950 h-2.5 rounded-full mb-6 overflow-hidden"><div class="progress-bar bg-indigo-500 h-full transition-all duration-300 shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: 0%"></div></div>
                <p class="text-6xl font-black text-indigo-400 tally-num">0</p>
            </div>
        `).join('') + (el.includeNota ? `
            <div class="candidate-result-item flex flex-col items-center bg-slate-900/50 p-8 rounded-[2.5rem] border border-slate-800" data-cid="NOTA" data-votes="0">
                <div class="w-24 h-24 rounded-full mb-6 bg-slate-800 flex items-center justify-center border-4 border-slate-700 text-slate-600"><svg class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg></div>
                <p class="font-black text-slate-500 text-lg mb-4 uppercase">NOTA</p>
                <div class="w-full bg-slate-950 h-2.5 rounded-full mb-6 overflow-hidden"><div class="progress-bar bg-slate-700 h-full transition-all" style="width: 0%"></div></div>
                <p class="text-6xl font-black text-slate-600 tally-num">0</p>
            </div>` : '');

        candidates.forEach(async c => {
            const img = document.getElementById(`count-img-${c.id}`);
            if(c.hasImage) {
                const b = await db.getImage(c.id);
                if(b) img.src = URL.createObjectURL(b);
            } else img.src = c.gender.toLowerCase().startsWith('f') ? femaleIcon : maleIcon;
        });

        const btn = document.getElementById('begin-counting-btn');
        btn.classList.remove('hidden');
        btn.onclick = () => runTallyAnimation(cls);
        showView('counting-screen-view');
        enterFullScreen(document.documentElement);
    };

    function runTallyAnimation(cls) {
        const el = getActiveElection();
        const votes = el.votes[cls];
        const btn = document.getElementById('begin-counting-btn');
        btn.classList.add('hidden');
        
        let i = 0;
        const itv = setInterval(() => {
            if(i >= votes.length) {
                clearInterval(itv);
                document.getElementById('counting-status').textContent = 'AUDIT COMPLETE';
                setTimeout(() => { exitFullScreen(); finalizeResults(cls); }, 1500);
                return;
            }
            
            const v = votes[i];
            const card = document.querySelector(`[data-cid="${v.cid}"]`);
            if(card) {
                const val = parseInt(card.dataset.votes) + 1;
                card.dataset.votes = val;
                card.querySelector('.tally-num').textContent = val;
                card.querySelector('.progress-bar').style.width = `${(val/votes.length)*100}%`;
                
                const emoji = document.createElement('div');
                emoji.className = 'counting-vote';
                emoji.innerHTML = 'ðŸ—³ï¸';
                document.body.appendChild(emoji);
                const rect = card.getBoundingClientRect();
                emoji.style.left = (window.innerWidth/2) + 'px';
                emoji.style.top = (window.innerHeight - 50) + 'px';
                setTimeout(() => {
                    emoji.style.transform = `translate(${rect.left - window.innerWidth/2 + rect.width/2}px, ${rect.top - window.innerHeight + 50}px) scale(1.5)`;
                    emoji.style.opacity = 0;
                }, 50);
                setTimeout(() => emoji.remove(), 700);
            }
            document.getElementById('counting-status').textContent = `CERTIFYING VOTE ${i+1} / ${votes.length}`;
            i++;
        }, 300);
    }

    // --- REPORTS ---
    document.getElementById('goto-reports-btn').onclick = () => showView('reports-view');
    document.getElementById('report-candidates-btn').onclick = () => generateCandidateListReport();
    
    // Instructions
    instructionsButton.onclick = () => {
        showModal({
            title: 'Protocol Guide',
            body: `<div class="space-y-4 text-sm font-medium">
                <p><strong class="text-blue-500">I. Import:</strong> Use Excel template. Clear names and classes required.</p>
                <p><strong class="text-blue-500">II. Session:</strong> Create a session and define a PIN. PIN is critical for finalizing results.</p>
                <p><strong class="text-blue-500">III. Images:</strong> All photos are auto-cropped to 1:1 square ratio for professional ballot display.</p>
                <p><strong class="text-blue-500">IV. Voting:</strong> Booth uses <kbd>TAB</kbd> to cycle students and <kbd>ESC</kbd> + PIN to close session.</p>
                <p><strong class="text-blue-500">V. Data:</strong> 100% Offline. Export daily to prevent browser data loss.</p>
            </div>`,
            cancelText: 'UNDERSTOOD'
        });
    };

    // --- SYSTEM INITIALIZATION ---
    const init = async () => {
        try {
            await db.init();
            const res = await fetch('schools.json');
            if(!res.ok) throw new Error();
            schoolsData = await res.json();
            loadState();
            if(!localStorage.getItem('alertDone')) {
                showModal({ title: 'OFFLINE MODE ENABLED', body: 'All data is stored locally in this browser. Clearing history or cache will erase all records. <strong class="text-white">Export backups daily.</strong>', cancelText: 'I UNDERSTAND', onCancel: () => localStorage.setItem('alertDone', 't') });
            }
        } catch (e) {
            document.body.innerHTML = `<div class="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-12 text-center">
                <div class="text-rose-500 mb-8"><svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                <h1 class="text-4xl font-black text-white mb-4 uppercase tracking-tighter">Server Access Required</h1>
                <p class="text-slate-400 max-w-sm mb-12">CORS policy blocks local file access. Run the folder via an HTTP server.</p>
                <div class="bg-slate-900 border border-slate-800 p-8 rounded-[2rem] font-mono text-left w-full max-w-md text-emerald-400">
                    <p class="text-slate-600 text-xs mb-4 uppercase font-black"># Run Command:</p>
                    python -m http.server 8000
                </div>
            </div>`;
        }
    };

    init();
    showView('homepage-view');
});

// Finalize Results Logic
function finalizeResults(cls) {
    const el = appData.elections.find(e => e.id === appData.activeElectionId);
    const votes = el.votes[cls] || [];
    const tallies = {};
    const candidates = el.candidates.filter(c => c.class === cls);
    
    candidates.forEach(c => tallies[c.id] = 0);
    if(el.includeNota) tallies['NOTA'] = 0;
    votes.forEach(v => { if(tallies[v.cid] !== undefined) tallies[v.cid]++; });
    
    const candidatesOnly = Object.entries(tallies).filter(([id]) => id !== 'NOTA');
    candidatesOnly.sort((a,b) => b[1] - a[1]);
    
    const winnerId = candidatesOnly[0]?.[0];
    const runnerId = candidatesOnly[1]?.[0];
    const winVotes = candidatesOnly[0]?.[1] || 0;
    const runVotes = candidatesOnly[1]?.[1] || 0;
    const lead = winVotes - runVotes;

    el.classStatus[cls] = { status: 'counted', winnerId };
    
    let body = `<div class="space-y-6 text-center">`;
    if(winnerId && winVotes > 0) {
        const winner = el.candidates.find(c => c.id === winnerId);
        body += `<div class="mb-4"><span class="bg-emerald-500/20 text-emerald-400 text-xs font-black px-4 py-1.5 rounded-full uppercase">Certified Result</span></div>
                 <h4 class="text-5xl font-black text-white tracking-tighter">${winner.name}</h4>
                 <p class="text-indigo-400 font-black text-xl mt-2">${winVotes} VOTES <span class="text-slate-600 mx-2">â€¢</span> LEAD: ${lead}</p>`;
    } else {
        body += `<h4 class="text-3xl font-black text-rose-500">NO WINNER</h4>`;
    }
    
    body += `<div class="bg-slate-950 p-8 rounded-[2.5rem] border border-slate-800 text-left space-y-4 mt-8">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest border-b border-slate-900 pb-2">Final Tally</p>`;
    Object.entries(tallies).sort((a,b)=>b[1]-a[1]).forEach(([id, count]) => {
        const name = id === 'NOTA' ? 'NOTA' : el.candidates.find(x => x.id === id).name;
        body += `<div class="flex justify-between items-center"><span class="font-bold text-slate-300">${name}</span><span class="font-black text-white text-xl">${count}</span></div>`;
    });
    body += `</div></div>`;
    
    localStorage.setItem('electionAppData', JSON.stringify(appData));
    showModal({ title: `CERTIFICATE: ${cls}`, body, cancelText: 'FINALIZE' });
    window.location.reload();
}

async function generateCandidateListReport() {
    const election = appData.elections.find(e => e.id === appData.activeElectionId);
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const femaleIcon = 'female.png';
    const maleIcon = 'male.png';
    
    doc.setFontSize(24);
    doc.setTextColor(30, 41, 59);
    doc.text(`BALLOT REGISTRY: ${appData.school.name}`, 14, 25);
    doc.setFontSize(11);
    doc.setTextColor(100, 116, 139);
    doc.text(`SESSION: ${election.name} | GENERATED: ${new Date().toLocaleString()}`, 14, 32);
    let y = 50;

    const grouped = election.candidates.reduce((acc, c) => { if(!acc[c.class]) acc[c.class] = []; acc[c.class].push(c); return acc; }, {});

    for (const cls of Object.keys(grouped).sort()) {
        if(y > 240) { doc.addPage(); y = 20; }
        doc.setFontSize(16);
        doc.setTextColor(59, 130, 246);
        doc.text(`CLASS UNIT: ${cls}`, 14, y);
        y += 6;

        const tableData = [];
        for(const c of grouped[cls]) {
            let imgBase64 = null;
            if(c.hasImage) {
                const blob = await db.getImage(c.id);
                if(blob) imgBase64 = await convertToBase64(blob);
            } else {
                imgBase64 = await convertToBase64(c.gender.toLowerCase().startsWith('f') ? femaleIcon : maleIcon);
            }
            tableData.push([{ content: '', image: imgBase64 }, c.name, c.gender]);
        }

        doc.autoTable({
            head: [['PORTRAIT', 'CANDIDATE NAME', 'GENDER']],
            body: tableData,
            startY: y,
            theme: 'grid',
            styles: { minCellHeight: 22, verticalAlign: 'middle', fontSize: 10, cellPadding: 2 },
            columnStyles: { 0: { cellWidth: 25 } },
            didDrawCell: (data) => {
                if (data.column.index === 0 && data.cell.section === 'body' && data.cell.raw.image) {
                    doc.addImage(data.cell.raw.image, 'JPEG', data.cell.x + 3.5, data.cell.y + 2, 18, 18);
                }
            }
        });
        y = doc.lastAutoTable.finalY + 15;
    }
    doc.save(`registry_${election.name.replace(/\s+/g, '_')}.pdf`);
}

function enterFullScreen(element) {
    if (element.requestFullscreen) element.requestFullscreen();
    else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
    else if (element.msRequestFullscreen) element.msRequestFullscreen();
}

function exitFullScreen() {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if (document.msExitFullscreen) document.msExitFullscreen();
}
</script>
</body>
</html>
